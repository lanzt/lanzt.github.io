---
layout      : post
title       : "HackTheBox - Planning"
author      : lanz
footer_image: assets/images/footer-card/linux-icon.png
footer_text : Linux
image       : https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-banner.png
category    : [ htb ]
tags        : [ path-traversal, crontab-ui, port-forwarding, grafana ]
---
Entorno Linux nivel f√°cil. Subdominios perdidos, monitoreo y ejecuci√≥n de cositas con `Grafana`, credenciales volando y `Crontab UI` bien escondido internamente y ejecuci√≥n de tareas autom√°ticas pa romper todo.

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-lab-information.png" style="width: 100%;"/>

**üí• Laboratorio creado por**: [d00msl4y3r](https://app.hackthebox.com/profile/128944) & [FisMatHack](https://app.hackthebox.com/profile/1076236).

## TL;DR (Spanish writeup)

Debajo del tapete tambi√©n hay que buscar.

Llegaremos a una plataforma de cursos, pero con poco que extraerle. Nos enfocaremos en buscar posibles subdominios, con eso llegaremos al servicio `Grafana`. Con credenciales previamente obtenidas, accederemos y encontraremos que la versi√≥n usada es vulnerable a una **lectura de archivos** y **ejecuci√≥n remota de comandos**, la aprovecharemos para generar una sesi√≥n como el usuario `root` en un contenedor de **Docker**.

En las variables de entorno encontraremos cositas, con ello generaremos otra sesi√≥n, esta vez en el host de la m√°quina como el usuario `enzo`.

Internamente, se est√° ejecutando el servicio `Crontab UI`, realizaremos un **redireccionamiento de puertos** para interactuar con la aplicaci√≥n. Jugaremos con ella para crear tareas programadas en el sistema y ejecutar comandos maliciosos. As√≠, obtendremos una terminal como el usuario `root` en el sistema host.

...

### Clasificaci√≥n de la m√°quina seg√∫n la gentesita

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-statistics.png" style="width: 80%;"/>

Muuucha enumeraci√≥n y vulns reales.

> La idea inicial de esta locura es tener mis "notas" por si algun d√≠a se me olvida todo (lo que es muuuy probable), leer esto y reencontrarme (o talvez no) üòÑ La segunda idea surgio con el tiempo, ya que me di cuenta que esta es una puerta para personitas que como yo al inicio (o simplemente a veces) nos estancamos en este mundo de la seguridad, por lo que si tengo la oportunidad de ayudarlos ¬øpor qu√© no hacerlo?

> Un detalle es que si ves mucho texto, es por que me gusta mostrar tanto errores como exitos y tambien plasmar todo desde una perspectiva m√°s de ense√±anza que de solo pasos a seguir. Sin menos, muchas gracias <3

...

Juguete.

1. [Reconocimiento](#reconocimiento)
2. [Enumeraci√≥n](#enumeracion)
  * [Dando vueltas por el puerto 80](#enumeracion-puerto-80)
  * [Encontrando servicios ocultos sobre el puerto 80](#enumeracion-puerto-80-grafana)
3. [Explotaci√≥n](#explotacion)
  * [Monitoreando archivos del sistema con Grafana](#explotacion-grafana-traversal)
  * [Ejecutando comandos en el sistema con Grafana](#explotacion-grafana-rce)
4. [Movimiento lateral: root (docker) -> enzo (host)](#lateral-environment-variables)
5. [Escalada de privilegios](#escalada-de-privilegios)
  * [Backups guardando credenciales](#escalada-backup)
  * [Puertos en la profundidad](#escalada-servicios-internos)
  * [Crontab UYYY](#escalada-crontabui)
6. [Post-Explotaci√≥n](#post-explotacion)

...

# Reconocimiento [#](#reconocimiento) {#reconocimiento}

Con ayuda de la herramienta `nmap`, vamos a descubrir que servicios (puertos) est√°n siendo alojados en la m√°quina:

```bash
nmap -p- --open -v 10.10.11.68 -oA tcp-all-htb_planning
```

| Par√°metro | Descripci√≥n |
| --------- | :---------- |
| -p-       | Escanea todos los 65535 puertos |
| --open    | Devuelve solo los puertos que est√©n abiertos |
| -v        | Permite ver en consola lo que va encontrando |
| -oA       | Guarda el output en diferentes formatos, entre ellos uno "grepeable". Lo usaremos junto a la funci√≥n [extractPorts](https://pastebin.com/raw/X6b56TQ8) de [S4vitar](https://s4vitar.github.io/) para copiar los puertos en la clipboard r√°pidamente |

El escaneo nos devuelve los servicios:

| Puerto | Descripci√≥n |
| ------ | :---------- |
| 22     | **[SSH](https://www.hackingarticles.in/ssh-penetration-testing-port-22/)**: Servicio que permite la obtenci√≥n de una terminal de forma segura |
| 80     | **[HTTP](https://searchnetworking.techtarget.com/definition/port-80)**: Servicio para interactuar con un servidor web |

> Usando la funci√≥n `extractPorts` (referenciada antes) podemos tener r√°pidamente los puertos en la clipboard, en este caso no es necesario ya que tenemos pocos puertos, pero si tuvi√©ramos varios evitamos tener que escribirlos uno a uno:
 
> `extractPorts tcp-all-htb_planning.gnmap`

Con los puertos a la mano, le volveremos a pedir ayuda a `nmap`, esta vez para que intente extraernos la versi√≥n de cada servicio y que le lance algunos scripts nativos a ver si logra obtener m√°s info:

```bash
nmap -sCV -p 22,80 10.10.11.68 -oA tcp-port-htb_planning
```

| Par√°metro | Descripci√≥n |
| --------- | :---------- |
| -p        | Indicamos a qu√© puertos queremos realizar el escaneo |
| -sC       | Ejecuta scripts predefinidos contra cada servicio |
| -sV       | Intenta extraer la versi√≥n del servicio |

Obtenemos:

| Puerto | Servicio | Versi√≥n |
| :----- | :------- | :------ |
| 22     | SSH      | OpenSSH 9.6p1 Ubuntu 3ubuntu13.11 (Ubuntu Linux; protocol 2.0) |
| 80     | HTTP     | nginx 1.24.0 (Ubuntu) |

Tambi√©n el puerto 80 nos indica que est√° realizando una redirecci√≥n a un dominio, o sea, intentando traducir el contenido de un dominio hacia una direcci√≥n IP, pero como no tenemos definido eso, el sistema no entiende y no realiza la redirecci√≥n. Ya veremos que significa esto.

Sigamos pues...

# Enumeraci√≥n [#](#enumeracion) {#enumeracion}

---

## Dando vueltas por el puerto 80 [üìå](#enumeracion-puerto-80) {#enumeracion-puerto-80}

Como ya vimos, el sitio web est√° realizando una redirecci√≥n a un dominio. Para que nuestro sistema entienda eso de "redirecci√≥n", debemos apoyarnos del archivo [/etc/hosts](https://es.siteground.com/kb/archivo-hosts/) en nuestro sistema, √©l se va a encargar de hablar con el sistema y decirle "toma el contenido alojado en un **sub/dominio** y resu√©lvelo contra esta **direcci√≥n IP** por favor":

```bash
‚ûß tail -n 1 /etc/hosts
10.10.11.68     planning.htb
```

> As√≠ que cuando visitemos `planning.htb`, va a ir a buscar el contenido alojado de ese dominio en la direcci√≥n IP `10.10.11.68`.

Y si ahora visitamos el sitio web:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-port80.png" style="width: 100%;"/>

Nos encontramos una plataforma para estudiar, nos brindan algunos cursos y dem√°s cositas as√≠, de todo logramos rescatar esta info:

* Este siendo ejecutado por `nginx 1.24.0`
* Hay un correo con un posible usuario: `info@planning.htb`

Pero por ahora nada llamativo...

## Encontrando servicios ocultos sobre el puerto 80 [üìå](#enumeracion-puerto-80-grafana) {#enumeracion-puerto-80-grafana}

Enumerando y enumerando, nos tiramos a descubrir posibles subdominios alojados sobre la misma IP (lo que ya hablamos sobre el `/etc/hosts`), para eso nos podemos apoyar en la herramienta `ffuf`:

> Ac√° dur√© LA DE TI EM PO, todo por no variar mi lista de palabras, as√≠ que recuerden, siempre prueben varias wordlists antes de desechar el ataque üòò

```bash
ffuf -c -w /opt/seclists/Discovery/DNS/n0kovo_subdomains.txt -u http://10.10.11.68 -H 'Host: FUZZ.planning.htb' -fs 178
```

Lo √∫nico que le decimos es, "toma cada l√≠nea de un diccionario de palabras (en este caso `n0kovo...`) y reemplaza esa palabra en la cabecera `Host`, formando algo tal que `HOLA.planning.htb`, si la respuesta es distinta a `178` (b√°sicamente quitamos falsos positivos), mu√©strame por fa" (y ya sabr√≠amos que existe un subdominio v√°lido).

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-bash-ffuf-subdomains.png" style="width: 100%;"/>

Upa, encontramos unooooo y al parecer relacionado con **Grafana**, lo agregamos al `/etc/hosts` y lo visitamos:

```bash
‚ûß tail -n 1 /etc/hosts
10.10.11.68     planning.htb grafana.planning.htb
```

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-page80grafana.png" style="width: 100%;"/>

¬°Efectivamente, encontramos el servicio [**Grafana**](https://grafana.com/)!!

> üëÅÔ∏è Es una herramienta que permite el analisis y monitoreo de informaci√≥n. 

Y si vemos un login, ¬øqu√© se nos ocurre? JA, pues probar las credenciales que nos dieron como parte de las pruebas:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-page80grafana-home.png" style="width: 100%;"/>

Funcionaleeeeees! Recorramos esta vuelta...

Nos encontramos la versi√≥n de **Grafana** que est√° siendo ejecutada:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-page80grafana-version.png" style="width: 30%;"/>

Esta nos sirve para buscar posibles vulnerabilidades en la web.

# Explotaci√≥n [#](#explotacion) {#explotacion}

---

## Monitoreando archivos del sistema con Grafana [üìå](#explotacion-grafana-traversal) {#explotacion-grafana-traversal}

Y s√≠, filtrando en internet sobre esa versi√≥n, nos encontramos el CVE [CVE-2024-9264](https://nvd.nist.gov/vuln/detail/cve-2024-9264), el cual se ve prometedor para nuestro entorno.

Es una vuln relacionada con una caracter√≠stica "experimental" que se implement√≥ y permite procesar expresiones como consultas SQL. Todo esto mediante la base de datos interna [DuckDB](https://duckdb.org/). El tema es que en ese proceso, las expresiones no est√°n correctamente sanitizadas y pueden permitir la lectura de archivos del sistema YYY la ejecuci√≥n remota de comandos üò≤

* [https://grafana.com/security/security-advisories/cve-2024-9264](https://grafana.com/security/security-advisories/cve-2024-9264/)
* [https://nvd.nist.gov/vuln/detail/cve-2024-9264](https://nvd.nist.gov/vuln/detail/cve-2024-9264)

Y las gu√≠a de las cuales extraeremos que hacer (y en las cuales hay muuucha m√°s info sobre la vuln si te interesa explorar):

* [https://www.sonicwall.com/blog/command-injection-and-local-file-inclusion-in-grafana-cve-2024-9264](https://www.sonicwall.com/blog/command-injection-and-local-file-inclusion-in-grafana-cve-2024-9264)
* [https://zekosec.com/blog/file-read-grafana-cve-2024-9264/](https://zekosec.com/blog/file-read-grafana-cve-2024-9264/)

As√≠ que veamos.

Lo primero que debemos hacer es ir al home (despu√©s de loguearnos) y crear un `Dashboard` para asignar las expresiones y despu√©s jugar con la petici√≥n para intentar leer archivos y posiblemente ejecutar comandos remotamente:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-page80grafana-createDashboard.png" style="width: 100%;"/>

Damos clic en `Create Dashboard`, despu√©s en `Add visualization` y despueeees en `Mixed`, llegamos a:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-page80grafana-mixedDashboard.png" style="width: 100%;"/>

Le agregamos una expresi√≥n matem√°tica, por ejemplo `1+1`:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-page80grafana-mixedDashboard-expression.png" style="width: 100%;"/>

Revisando nuestro **Burp Suite**, deber√≠a habernos interceptado la petici√≥n en crudo:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-burp-req-mixedDashboard-expression.png" style="width: 100%;"/>

Tenemos el resultado de la expresi√≥n, as√≠ que todo funcionando. Nos llevamos esa petici√≥n al **Repeater** y seguimos jugando.

Seg√∫n la gu√≠a, debemos modificar el tipo de expresi√≥n de `math` a `sql` e inyectar como expresi√≥n una sentencia (usando la funci√≥n `read_csv_auto` de **DuckDB**) para leer un archivo del sistema (en este caso `/etc/passwd`, el archivo con informaci√≥n de usuarios):

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-burp-reqYres-expression-pathTraversal.png" style="width: 100%;"/>

AYYYY! Podemos leer archivos del sistemaaaaaa, listo listo...

## Ejecutando comandos en el sistema con Grafana [üìå](#explotacion-grafana-rce) {#explotacion-grafana-rce}

Antes de volvernos locos enumerando archivos, recordemos que posiblemente tambi√©n se pueda ejecutar comandos, por lo que con eso en mente, encontramos este script hecho en **Python** que automatiza ese proceso:

>  Lo que cambia de la expresi√≥n es el uso de la extensi√≥n [shellfs](https://duckdb.org/community_extensions/extensions/shellfs.html), la cual permite enviar comandos al sistema.

* [https://github.com/nollium/CVE-2024-9264](https://github.com/nollium/CVE-2024-9264)

Intentamos ejecutar el comando `id`:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-bash-py-expression-rce-id.png" style="width: 100%;"/>

FUNCIONAAAAAAAAAAAAA! Levantemos un puerto (`nc -lvp 4450`) e indiqu√©mosle al servidor que nos env√≠e una terminal remota:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-bash-py-expression-rce-reverseShell.png" style="width: 100%;"/>

¬°Listones, tamos que tamos!

# Variabilidad: root (docker) -> enzo (host) [#](#lateral-environment-variables) {#lateral-environment-variables}

Algo que notamos es que estamos en un [contenedor de Docker](https://www.docker.com/resources/what-container/), esto debido a que nuestro **hostname** tiene el **ID** del contenedor o que si listamos nuestra `IP`, nos va a mostrar una dentro del rango `172.17.0.0/16`.

Por lo cual, necesitamos "escaparnos" de ah√≠ y llegar al host, que es el que est√° alojando el contenedor (y si existen m√°s, pues los contenedores).

En busca de credenciales, buscamos archivos de configuraci√≥n relacionados con `Grafana` y encontramos [este recurso](https://grafana.com/docs/grafana/latest/setup-grafana/configure-grafana/), en √©l se nos indica que pueden existir datos en las [variables de entorno](https://kinsta.com/es/base-de-conocimiento/variables-de-entorno/).

Si revisamos, efectivamente tenemos info:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-rootDockerRevSH-bash-env.png" style="width: 100%;"/>

Estas variables de entorno tienen unas credenciales:

```bash
GF_SECURITY_ADMIN_PASSWORD
GF_SECURITY_ADMIN_USER
```

¬øY si son funcionales no solo en **Grafana**, sino que en el sistema? Pues probemos:

```bash
ssh enzo@planning.htb
```

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-enzoSH-bash.png" style="width: 100%;"/>

ü§™ üò≥ üòú

# Escalada de privilegios [#](#escalada-de-privilegios) {#escalada-de-privilegios}

Nos ponemos a enumerar y encontramos cositas.

## Backups guardando credenciales [üìå](#escalada-backup) {#escalada-backup}

Tenemos un archivo de base de datos en el directorio `/opt/crontabs`:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-enzoSH-bash-crontabDB.png" style="width: 100%;"/>

Las `crontabs` son los archivos en los cuales se listan las `cronjobs`, ¬øy qu√© es una `cronjob`? Es una tarea que se programa para que sea ejecutada de forma autom√°tica sobre el paso del tiempo.

En este caso hay una llamativa: est√° realizando un backup yyyy colocaron una **contrase√±a** para la creaci√≥n del comprimido:

```bash
/usr/bin/docker save root_grafana -o /var/backups/grafana.tar
/usr/bin/gzip /var/backups/grafana.tar
zip -P P4ssw0rdS0pRi0T3c /var/backups/grafana.tar.gz.zip /var/backups/grafana.tar.gz
rm /var/backups/grafana.tar.gz
```

Pero no tenemos control sobre ning√∫n comando, as√≠ que esto va a ser meramente informativo, nos guardamos la contrase√±a y el nombre del contenedor por s√≠ algo:

```bash
root_grafana
P4ssw0rdS0pRi0T3c
```

## Puertos en la profundidad [üìå](#escalada-servicios-internos) {#escalada-servicios-internos}

Revisando si existen servicios internamente, encontramos el de `Grafana` sobre el puerto **3000** y otro sobre el puerto **5000**:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-enzoSH-bash-netstat.png" style="width: 100%;"/>

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-enzoSH-bash-curl-localhost5000.png" style="width: 100%;"/>

Jmmm, est√° solicitando credenciales para acceder, tenemos varias, probando y probandoooo, al usar las recientemente descubiertas:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-enzoSH-bash-curl-help-user.png" style="width: 100%;"/>

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-enzoSH-bash-curl-localhost5000-user-access.png" style="width: 100%;"/>

Tenemos accesoooooo :P

## Crontab UYYY [üìå](#escalada-crontabui) {#escalada-crontabui}

Tenemos como parte de la respuesta un t√≠tulo curioso: `Crontab UI`, si buscamos en la web, llegamos a este repo:

* [https://github.com/alseambusher/crontab-ui](https://github.com/alseambusher/crontab-ui)

> üíº Una forma grafica y sencilla de manejar tooodas las **cronjobs** del sistema.

Lindo lindo, buena herramienta.

¬øPero y c√≥mo hacemos para interactuar correctamente con ella de forma gr√°fica? Jugando con un concepto llamado **reenv√≠o de puertos**, el cual permite enviar el contenido alojado en un puerto (ya sea interno o externo) a otro puerto (tambi√©n interno o externo).

En este caso nos va a servir para: tomar el contenido del puerto `8000` (el servicio **Crontab UI** internamente) y enviarlo por ejemplo al puerto `8000` de nuestra m√°quina, por lo tanto, es un reenv√≠o de puertos local.

* [A Visual Guide to SSH Tunnels: Local and Remote Port Forwarding](https://iximiuz.com/en/posts/ssh-tunnels/)

Con ayuda de `SSH` podemos hacerlo:

```bash
ssh enzo@planning.htb -L 8000:127.0.0.1:8000
```

Y si ahora visitamos el puerto `8000` de nuestra m√°quina local:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-pageLocalhost8000-crontabui-forward-login.png" style="width: 100%;"/>

Nos solicita credenciales (tal y como hicimos con la petici√≥n mediante `curl`), las colocamos:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-pageLocalhost8000-crontabui-forward-dashboard.png" style="width: 100%;"/>

Y tamos dentro!

...

Tenemos acceso a la creaci√≥n de tareas automatizadas, hagamos que nos ejecute una reverse shell:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-enzoSH-bash-script-reverseShell.png" style="width: 100%;"/>

Levantamos el puerto en nuestra m√°quina `nc -lvp 4450` y ahora si, con ayuda de `Crontab UI` generamos la tarea cron para que sea ejecutada a cada minuto:

* [https://crontab.guru](https://crontab.guru)

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-pageLocalhost8000-crontabui-forward-new-cron.png" style="width: 100%;"/>

Guardamos y obtenemos:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-pageLocalhost8000-crontabui-forward-created-cron.png" style="width: 100%;"/>

Pa no esperar, damos clic en `Run now` yyyyyy:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-bash-rootRevSH.png" style="width: 100%;"/>

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-bash-rootRevSH-whoami.png" style="width: 100%;"/>

Contamos con acceso completo al sistema como el usuario `root`!! Y listones :P

# Post-Explotaci√≥n [#](#post-explotacion) {#post-explotacion}

---

## Flags [üìå](#post-explotacion-flags) {#post-explotacion-flags}

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/planning/htbPLANNING-flags.png" style="width: 100%;"/>

...

Listones, buena m√°quina, nos puso a prueba en t√©rminos de enumeraci√≥n (y record√≥ el uso de varios diccionarios para ataques de fuerza bruta). Tambi√©n recordamos el concepto del **reenv√≠o de puertos**, me gust√≥.

Por ahora no es m√°s, muchas gracias por tomarte el tiempo de leer y nos seguiremos encontrando por ah√≠, abrazos :3